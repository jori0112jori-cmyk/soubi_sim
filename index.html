<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>ãƒ©ã‚¹ãƒˆã‚¦ã‚©ãƒ¼è‚²æˆã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼</title>
<style>
    /* === ãƒ™ãƒ¼ã‚¹è¨­å®š === */
    body { font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue", Arial, sans-serif; background-color: #f0f2f5; color: #333; padding: 10px; padding-bottom: 120px; margin: 0; font-size: 14px; line-height: 1.4; }
    h1 { font-size: 1.2rem; text-align: center; color: #2c3e50; margin: 10px 0 15px; font-weight: 900; letter-spacing: 1px; }
    .container { max-width: 900px; margin: 0 auto; }
    
    /* === ã‚¿ãƒ–ãƒ¡ãƒ‹ãƒ¥ãƒ¼ === */
    .tabs { display: flex; background: #dfe4ea; border-radius: 8px; padding: 3px; margin-bottom: 15px; }
    .tab-btn { flex: 1; padding: 10px 0; text-align: center; font-size: 0.9rem; font-weight: bold; color: #7f8c8d; cursor: pointer; border-radius: 6px; transition: 0.2s; }
    .tab-btn.active { background: #fff; color: #2980b9; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .tab-content { display: none; }
    .tab-content.active { display: block; animation: fadeIn 0.3s; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(3px); } to { opacity: 1; transform: translateY(0); } }

    /* === ãƒ‘ãƒãƒ«å…±é€š === */
    .panel { background: #fff; padding: 12px; border-radius: 10px; box-shadow: 0 2px 6px rgba(0,0,0,0.03); margin-bottom: 12px; border: 1px solid #eee; }
    .panel-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #f0f0f0; padding-bottom: 8px; margin-bottom: 10px; font-size: 0.95rem; font-weight: 900; color: #2c3e50; }
    .reset-btn { font-size: 0.7rem; background: #fff; color: #7f8c8d; border: 1px solid #ccc; padding: 4px 10px; border-radius: 4px; cursor: pointer; }

    /* === AIææ¡ˆãƒ‘ãƒãƒ« === */
    .ai-panel { background: linear-gradient(135deg, #fdfbfb, #ebedee); border-left: 4px solid #3498db; }
    .ai-title { color: #2980b9; font-weight: bold; display: flex; align-items: center; gap: 6px; font-size: 0.95rem; margin-bottom: 8px; }
    .suggestion-box { background: #fff; border-radius: 6px; padding: 12px; font-size: 0.85rem; line-height: 1.6; border: 1px solid #e1e8ed; color: #444; }
    .swap-candidate { margin-top: 10px; padding-top: 10px; border-top: 1px dashed #ddd; background: #fffbf2; padding: 10px; border-radius: 6px; border: 1px solid #fce8b2; color: #555; }
    .swap-title { font-weight: bold; color: #e67e22; display: block; margin-bottom: 4px; font-size: 0.9rem; }
    .score-breakdown { font-size: 0.7rem; color: #999; margin-top: 5px; text-align: right; }

    /* === éƒ¨éšŠç·¨æˆ UI === */
    .squad-section { border: 1px solid #e1e8ed; border-radius: 8px; overflow: hidden; margin-bottom: 12px; background: #fff; }
    .squad-header { background: #f8f9fa; padding: 10px 12px; font-weight: bold; color: #444; display: flex; justify-content: space-between; align-items: center; cursor: pointer; font-size: 0.9rem; border-bottom: 1px solid #eee; }
    .squad-body { padding: 12px; display: none; background: #fff; }
    .squad-body.open { display: block; }
    
    .hero-slot { display: flex; gap: 5px; margin-bottom: 8px; align-items: center; padding: 6px; border-radius: 6px; border: 1px solid #eee; }
    .slot-front { background-color: #fffaf0; border-left: 3px solid #f39c12; }
    .slot-back { background-color: #f0f8ff; border-left: 3px solid #3498db; }

    .pos-badge { font-size: 0.65rem; font-weight: bold; padding: 3px 0; width: 34px; text-align: center; border-radius: 3px; color: #fff; flex-shrink: 0; }
    .badge-front { background-color: #f39c12; }
    .badge-back { background-color: #3498db; }

    .hero-select { flex: 1; min-width: 0; padding: 8px 4px; border-radius: 4px; border: 1px solid #ddd; font-size: 0.9rem; font-weight: bold; color: #333; background: #fff; text-overflow: ellipsis; white-space: nowrap; overflow: hidden; }
    
    /* === æ­¦è£…Lvå…¥åŠ› === */
    .wp-wrap { display: flex; align-items: center; gap: 3px; flex-shrink: 0; }
    .wp-label { font-size: 0.65rem; color: #888; font-weight: bold; }
    
    /* ã‚¹ãƒ†ãƒƒãƒ‘ãƒ¼å…±é€š */
    .stepper { display: flex; align-items: center; background: #fff; border: 1px solid #ccc; border-radius: 4px; overflow: hidden; height: 32px; }
    .stepper button { width: 26px; height: 100%; border: none; background: #f4f6f7; font-size: 1rem; font-weight: bold; color: #555; cursor: pointer; padding: 0; flex-shrink: 0; }
    .stepper button:active { background: #dcdcdc; }
    .stepper input { flex: 1; width: 100%; min-width: 0; text-align: center; border: none; font-size: 0.9rem; font-weight: bold; padding: 0; background: transparent; }
    .stepper.disabled { background: #eee; opacity: 0.5; pointer-events: none; }
    .stepper.disabled input { color: #888; font-size: 0.8rem; }

    /* === é™£å½¢ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ« === */
    .visual-area { margin-top: 15px; padding-top: 10px; border-top: 1px dashed #ddd; background: #fafafa; border-radius: 6px; padding: 10px; }
    .visual-label { font-size: 0.7rem; color: #999; text-align: center; margin-bottom: 6px; font-weight: bold; display: block; }
    .visual-grid { display: flex; flex-direction: column; gap: 6px; }
    .v-row-front { display: flex; justify-content: center; gap: 8px; }
    .v-row-back { display: flex; justify-content: center; gap: 8px; }
    
    .hero-card { 
        width: 30%; max-width: 90px; padding: 4px 2px; text-align: center; border-radius: 6px; 
        border: 1px solid #ddd; box-shadow: 0 1px 2px rgba(0,0,0,0.05); background: #fff; height: 50px; 
        display: flex; flex-direction: column; justify-content: center; align-items: center; position: relative;
    }
    .card-tank { background: #fff8e1; border-color: #ffe0b2; color: #e65100; }
    .card-air { background: #e3f2fd; border-color: #bbdefb; color: #0d47a1; }
    .card-mis { background: #fbe9e7; border-color: #ffccbc; color: #bf360c; }
    .card-none { background: #f5f5f5; border-color: #eee; color: #ccc; }
    
    .role-icon { position: absolute; top: 2px; right: 2px; font-size: 0.7rem; }
    .hc-name { font-weight: bold; font-size: 0.7rem; width: 95%; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; line-height: 1.2; margin-top: 2px; }
    .hc-wp { font-size: 0.65rem; font-weight: bold; opacity: 0.8; margin-top: 1px; }

    /* ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚¨ãƒªã‚¢ */
    .advice { font-size: 0.85rem; padding: 12px; border-radius: 6px; margin-top: 10px; line-height: 1.5; background: #fffbf2; border-left: 4px solid #f39c12; color: #444; }
    .adv-ok { background: #f0fdf4; border-color: #27ae60; color: #14532d; }
    .adv-ng { background: #fef2f2; border-color: #e74c3c; color: #991b1b; }

    /* === è£…å‚™ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ === */
    .gear-container { display: flex; flex-wrap: wrap; gap: 10px; }
    .g-card { flex: 1; min-width: 100%; background: #fff; padding: 12px 10px; border-radius: 10px; border: 1px solid #e1e8ed; box-shadow: 0 2px 5px rgba(0,0,0,0.03); box-sizing: border-box; }
    @media (min-width: 700px) { .g-card { min-width: 48%; } }
    
    .g-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px; }
    .g-label { font-weight: bold; font-size: 0.8rem; color: #555; display: flex; align-items: center; gap: 2px; min-width: 40px; }
    
    .g-input-group { display: flex; gap: 4px; justify-content: flex-end; flex: 1; }
    .stepper-lv { width: 85px; } 
    .stepper-star { width: 120px; } 
    .stepper-star input { font-size: 13px; letter-spacing: -2px; padding-left: 2px; }

    /* ãƒãƒ•æƒ…å ± */
    .buff-info { font-size: 0.7rem; color: #e67e22; background: #fffbf2; padding: 5px; border-radius: 4px; margin-top: 10px; text-align: center; border: 1px dashed #f39c12; display: none; }
    .buff-info.active { display: block; }

    /* å¿…è¦å›³é¢ãƒ‘ãƒãƒ« */
    .cost-panel { margin-top: 12px; background: #fff; padding: 10px; border-radius: 8px; border-top: 3px solid #f39c12; box-shadow: 0 2px 6px rgba(0,0,0,0.05); }
    .cost-row { display: flex; justify-content: space-between; font-size: 0.85rem; border-bottom: 1px dashed #eee; padding: 4px 0; }
    .cost-row:last-child { border-bottom: none; }

    /* === ãƒ•ãƒƒã‚¿ãƒ¼ === */
    .footer { position: fixed; bottom: 10px; left: 50%; transform: translateX(-50%); width: 94%; max-width: 600px; background: rgba(255,255,255,0.95); backdrop-filter: blur(8px); padding: 8px 12px; border-radius: 50px; border: 1px solid #fadbd8; text-align: center; box-shadow: 0 4px 15px rgba(0,0,0,0.1); z-index: 999; font-weight: bold; color: #c0392b; display: flex; justify-content: space-between; align-items: center; }
    .ft-main { font-size: 1rem; }
    .ft-sub { font-size: 0.75rem; color: #555; background: #f8f9fa; padding: 2px 8px; border-radius: 10px; border: 1px solid #eee; }
</style>
</head>
<body>

<div class="container">
    <h1>è‚²æˆã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ <span style="font-size:0.7rem; color:#999; font-weight:normal;">v13.0 (Star Lock Fix)</span></h1>

    <div class="tabs">
        <div class="tab-btn active" onclick="showTab('squad')">âš”ï¸ éƒ¨éšŠç·¨æˆ</div>
        <div class="tab-btn" onclick="showTab('gear')">ğŸ›¡ï¸ è£…å‚™ã‚·ãƒŸãƒ¥</div>
    </div>

    <div id="tab-squad" class="tab-content active">
        <div class="panel ai-panel">
            <div class="ai-title">
                <span>ğŸ¤– ç·¨æˆææ¡ˆ & å…¥æ›¿å€™è£œ</span>
                <button class="reset-btn" onclick="generateAiSuggestion()">å†åˆ†æ</button>
            </div>
            <div id="ai-result" class="suggestion-box" style="display:none;"></div>
            <div id="ai-placeholder" style="font-size:0.8rem; color:#777; padding:5px;">
                å„éƒ¨éšŠã®æ­¦è£…Lvã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚å…¨ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰æœ€é©ãªçµ„ã¿åˆã‚ã›ã‚’åˆ†æã—ã¾ã™ã€‚
            </div>
        </div>

        <div class="panel" style="background:transparent; padding:0; border:none; box-shadow:none;">
            <div style="display:flex; justify-content:flex-end; margin-bottom:5px;">
                <button class="reset-btn" onclick="resetSquads()" style="background:#fff; border-color:#e1e8ed;">ğŸ—‘ï¸ å…¨ç·¨æˆãƒªã‚»ãƒƒãƒˆ</button>
            </div>
            <div id="squad-container"></div>
        </div>
    </div>

    <div id="tab-gear" class="tab-content">
        <div class="gear-container">
            <div class="g-card">
                <div class="panel-header" style="color:#7f8c8d; border-color:#eee;">ç¾åœ¨ã®è£…å‚™</div>
                
                <div class="g-row" style="margin-bottom:12px;">
                    <span class="g-label">âš”ï¸ æ­¦è£…Lv</span>
                    <div class="stepper" style="width:100px;"><button onclick="gearStep('cWeapon', -1)">-</button><input id="cWeapon" value="20" readonly><button onclick="gearStep('cWeapon', 1)">+</button></div>
                </div>
                <div id="current-gear-rows"></div>
                <div id="detail-curr" class="buff-info"></div>
            </div>

            <div class="g-card">
                <div class="panel-header" style="color:#c0392b; border-color:#fadbd8;">
                    ç›®æ¨™ã®è£…å‚™ <button class="reset-btn" onclick="resetGear()">ã‚¯ãƒªã‚¢</button>
                </div>
                
                <div class="g-row" style="margin-bottom:12px;">
                    <span class="g-label" style="color:#c0392b;">âš”ï¸ ç›®æ¨™Lv</span>
                    <div class="stepper" style="border-color:#fadbd8; width:100px;"><button onclick="gearStep('tWeapon', -1)">-</button><input id="tWeapon" value="20" readonly><button onclick="gearStep('tWeapon', 1)">+</button></div>
                </div>
                <div id="target-gear-rows"></div>
                <div id="detail-tgt" class="buff-info"></div>
            </div>
        </div>
        
        <div class="cost-panel">
            <div style="font-weight:bold; color:#d35400; font-size:0.9rem; margin-bottom:5px;">ğŸ†™ ä¸è¶³ã—ã¦ã„ã‚‹è£…å‚™ãƒ¬ã‚·ãƒ”</div>
            <div id="cost-list" style="margin-bottom:10px;"></div>
            <div style="font-size:0.7rem; color:#888; background:#f9f9f9; padding:6px; border-radius:4px; text-align:center;">
                â˜…0â†’1:5 / â˜…1â†’2:10 / â˜…2â†’3:15 / â˜…3â†’4:20 / â˜…4â†’5:èµ¤10
            </div>
        </div>
    </div>
</div>

<div id="footer-bar" class="footer" style="display:none;">
    <div class="ft-main">ä»Šã‚ˆã‚Š <span id="growth-rate" style="font-size:1.3rem;">1.00</span> å€!</div>
    <div class="ft-sub">å¿…è¦: <span style="color:#f39c12;">UR<span id="ft-ur">0</span></span> <span style="color:#c0392b;">MR<span id="ft-mr">0</span></span></div>
</div>

<script>
// --- ãƒ‡ãƒ¼ã‚¿å®šç¾© ---
const HEROES = {
    empty: {n:"- æœªè¨­å®š -", t:"none", r:"none", ur:false},
    murphy: {n:"ãƒãƒ¼ãƒ•ã‚£", t:"tank", r:"wall", ur:false},
    williams: {n:"ã‚¦ã‚£ãƒªã‚¢ãƒ ã‚º", t:"tank", r:"wall", ur:false},
    scarlett: {n:"ã‚¹ã‚«ãƒ¼ãƒ¬ãƒƒãƒˆ", t:"tank", r:"wall", ur:true},
    violet: {n:"ãƒ´ã‚£ã‚ªãƒ©", t:"tank", r:"wall", ur:true},
    kimberly: {n:"ã‚­ãƒ³ãƒãƒªãƒ¼", t:"tank", r:"atk", ur:false},
    stetmann: {n:"ã‚¹ãƒ†ãƒƒãƒ‰ãƒãƒ³", t:"tank", r:"atk", ur:false},
    mason: {n:"ãƒ¡ã‚¤ã‚½ãƒ³", t:"tank", r:"atk", ur:true},
    marshall: {n:"ãƒãƒ¼ã‚·ãƒ£ãƒ«", t:"tank", r:"sup", ur:false},
    lucius: {n:"ãƒ«ã‚·ã‚¦ã‚¹", t:"air", r:"wall", ur:false},
    carlie: {n:"ã‚«ãƒ¼ãƒªãƒ¼", t:"air", r:"wall", ur:false},
    dva: {n:"DVA", t:"air", r:"atk", ur:false},
    schuyler: {n:"ã‚¹ã‚«ã‚¤ãƒ©ãƒ¼", t:"air", r:"atk", ur:false},
    morrison: {n:"ãƒ¢ãƒªã‚½ãƒ³", t:"air", r:"atk", ur:false},
    sarah: {n:"ã‚µãƒ©", t:"air", r:"atk", ur:true},
    mcgregor: {n:"ãƒã‚¯ãƒ¬ã‚¬ãƒ¼", t:"mis", r:"wall", ur:false},
    adam: {n:"ã‚¢ãƒ€ãƒ ", t:"mis", r:"wall", ur:false},
    tesla: {n:"ãƒ†ã‚¹ãƒ©", t:"mis", r:"atk", ur:false},
    fiona: {n:"ãƒ•ã‚£ã‚ªãƒŠ", t:"mis", r:"atk", ur:false},
    swift: {n:"ã‚¹ã‚¦ã‚£ãƒ•ãƒˆ", t:"mis", r:"atk", ur:false},
    venom: {n:"ãƒ™ãƒãƒ ", t:"mis", r:"atk", ur:true}
};

const GEAR_TYPES = ['Gun', 'Data', 'Armor', 'Radar'];
const GEAR_NAMES = { 'Gun':'ğŸ”«ãƒ¬ãƒ¼ãƒ«ã‚¬ãƒ³', 'Data':'ğŸ’¾ãƒãƒƒãƒ—', 'Armor':'ğŸ›¡ï¸è£…ç”²', 'Radar':'ğŸ“¡ãƒ¬ãƒ¼ãƒ€ãƒ¼' };

// --- åˆæœŸåŒ– ---
window.onload = function() {
    initSquadHTML();
    initGearHTML();
    loadAllData();
    calculateGear();
    generateAiSuggestion();
};

function showTab(id) {
    document.querySelectorAll('.tab-content').forEach(e => e.classList.remove('active'));
    document.querySelectorAll('.tab-btn').forEach(e => e.classList.remove('active'));
    document.getElementById('tab-'+id).classList.add('active');
    event.currentTarget.classList.add('active');
    document.getElementById('footer-bar').style.display = (id === 'gear') ? 'flex' : 'none';
}

// --- éƒ¨éšŠç·¨æˆ ---
function initSquadHTML() {
    let html = '';
    for(let s=1; s<=3; s++) {
        let openClass = s === 1 ? 'open' : '';
        let arrow = s === 1 ? 'â–¼' : 'â–¶';
        html += `
        <div class="squad-section">
            <div class="squad-header" onclick="toggleSquad(${s}, this)">
                <span>ç¬¬${s}éƒ¨éšŠ</span><span>${arrow}</span>
            </div>
            <div class="squad-body ${openClass}" id="sq-body-${s}">
                ${[1,2,3,4,5].map(p => {
                    let isFront = p<=2;
                    let slotClass = isFront ? "slot-front" : "slot-back";
                    let badgeClass = isFront ? "badge-front" : "badge-back";
                    let label = isFront ? "å‰è¡›" : "å¾Œè¡›";
                    return `
                    <div class="hero-slot ${slotClass}">
                        <div class="pos-badge ${badgeClass}">${label}</div>
                        <select class="hero-select" id="h-${s}-${p}" onchange="updateSquad(${s})"></select>
                        <div class="wp-wrap">
                            <span class="wp-label">Lv</span>
                            <div class="stepper" id="wp-box-${s}-${p}" style="width:100px; height:32px;">
                                <button onclick="stepWp(${s},${p},-1)">-</button>
                                <input type="text" id="w-${s}-${p}" value="0" readonly>
                                <button onclick="stepWp(${s},${p},1)">+</button>
                            </div>
                        </div>
                    </div>`;
                }).join('')}
                <div class="visual-area">
                    <span class="visual-label">é…ç½®ã‚¤ãƒ¡ãƒ¼ã‚¸</span>
                    <div id="vis-${s}" class="visual-grid"></div>
                </div>
                <div id="adv-${s}" class="advice" style="display:none;"></div>
            </div>
        </div>`;
    }
    document.getElementById('squad-container').innerHTML = html;
    
    let opts = "";
    for(let k in HEROES) {
        let h = HEROES[k];
        let mark = h.t==='tank'?'[æˆ¦]': h.t==='air'?'[ç©º]': h.t==='mis'?'[ï¾›ï½¹]':'';
        if(k==='empty') mark = '';
        let name = h.n + (h.ur ? "(UR)" : "");
        opts += `<option value="${k}">${mark} ${name}</option>`;
    }
    document.querySelectorAll('.hero-select').forEach(sel => sel.innerHTML = opts);
}

function toggleSquad(s, header) {
    let body = document.getElementById(`sq-body-${s}`);
    let arrow = header.children[1];
    if(body.classList.contains('open')) {
        body.classList.remove('open'); arrow.innerText = 'â–¶';
    } else {
        body.classList.add('open'); arrow.innerText = 'â–¼';
    }
}

function stepWp(s, p, d) {
    let el = document.getElementById(`w-${s}-${p}`);
    let val = el.value === "æœªè§£æ”¾" || el.value === "æœªå®Ÿè£…" ? 0 : parseInt(el.value);
    let v = val || 0;
    let newVal = Math.min(Math.max(v + d, 0), 30);
    
    el.value = newVal;
    updateSquad(s);
}

function updateSquad(s) {
    lockDuplicateHeroes(s);
    let members = [];
    let counts = {tank:0, air:0, mis:0, none:0};

    for(let p=1; p<=5; p++) {
        let hid = document.getElementById(`h-${s}-${p}`).value;
        let wpEl = document.getElementById(`w-${s}-${p}`);
        let wpBox = document.getElementById(`wp-box-${s}-${p}`);
        let h = HEROES[hid];

        let currentVal = wpEl.value === "æœªè§£æ”¾" || wpEl.value === "æœªå®Ÿè£…" ? 0 : parseInt(wpEl.value) || 0;

        if(h.ur) {
            wpBox.classList.add('disabled');
            wpEl.value = "æœªå®Ÿè£…";
            currentVal = 0;
        } else if(hid === 'empty') {
            wpBox.classList.add('disabled');
            wpEl.value = "-";
            currentVal = 0;
        } else {
            wpBox.classList.remove('disabled');
            wpEl.value = currentVal === 0 ? "æœªè§£æ”¾" : currentVal;
        }

        members.push({ ...h, id:hid, wp:currentVal, pos:p });
        counts[h.t]++;
    }

    renderVisual(s, members);
    analyzeSquad(s, members, counts);
    saveData();
    generateAiSuggestion(); 
}

function lockDuplicateHeroes(s) {
    let selected = [];
    for(let p=1; p<=5; p++) {
        let v = document.getElementById(`h-${s}-${p}`).value;
        if(v !== 'empty') selected.push(v);
    }
    for(let p=1; p<=5; p++) {
        let sel = document.getElementById(`h-${s}-${p}`);
        let myVal = sel.value;
        for(let opt of sel.options) {
            if(opt.value !== 'empty' && selected.includes(opt.value) && opt.value !== myVal) {
                opt.disabled = true; opt.style.color = "#ccc";
            } else {
                opt.disabled = false; opt.style.color = "#333";
            }
        }
    }
}

function renderVisual(s, m) {
    let html = m.map(h => {
        if(h.id === 'empty') return `<div class="hero-card card-none"><span style="font-size:0.7rem;">æœªè¨­å®š</span></div>`;
        let cls = h.t === 'tank' ? 'card-tank' : h.t === 'air' ? 'card-air' : 'card-mis';
        let roleIcon = h.r === 'wall' ? 'ğŸ›¡ï¸' : h.r === 'atk' ? 'âš”ï¸' : 'ğŸ› ï¸';
        let urTag = h.ur ? '<span style="color:#8e44ad;font-size:0.6rem;">(UR)</span>' : '';
        let wpTxt = h.ur ? 'æœªå®Ÿè£…' : (h.wp === 0 ? 'æœªè§£æ”¾' : `Lv${h.wp}`);
        return `
        <div class="hero-card ${cls}">
            <div class="role-icon">${roleIcon}</div>
            <div class="hc-name">${h.n}${urTag}</div>
            <div class="hc-wp">${wpTxt}</div>
        </div>`;
    });
    
    let front = `<div class="v-row-front">${html[0]}${html[1]}</div>`;
    let back = `<div class="v-row-back">${html[2]}${html[3]}${html[4]}</div>`;
    document.getElementById(`vis-${s}`).innerHTML = front + back;
}

function analyzeSquad(s, m, c) {
    let div = document.getElementById(`adv-${s}`);
    if(c.none > 0) { div.style.display = 'none'; return; }
    div.style.display = 'block';

    let maxC = Math.max(c.tank, c.air, c.mis);
    let buff = maxC===5?"+20%": maxC===4?"+15%": maxC===3?"+10%":"0%";
    let mainT = Object.keys(c).reduce((a,b)=> c[a]>c[b]?a:b);
    
    let msgs = [`<b> åŒç¨®è‹±é›„${maxC}ä½“ (æˆ¦é—˜ä¸­,ä½“åŠ›,æ”»æ’ƒåŠ›,é˜²å¾¡åŠ›${buff})</b>`];
    let status = 'ok';

    if(['atk','sup'].includes(m[0].r) || ['atk','sup'].includes(m[1].r)) {
        msgs.push("âš ï¸ å‰è¡›ã«ç«åŠ›/æ”¯æ´ãŒã„ã¾ã™ã€‚ç›¾å½¹(ğŸ›¡ï¸)ã‚’æ¨å¥¨ã€‚");
        status = 'ng';
    }

    if(maxC === 4) {
        let out = m.find(h => h.t !== mainT);
        if(out.id === 'lucius') {
            if(out.wp < 10) { msgs.push("âš ï¸ ãƒ«ã‚·ã‚¦ã‚¹å‡ºå¼µã¯ã€æ­¦è£…Lv10ã€‘ä»¥ä¸ŠãŒå¿…é ˆã§ã™ã€‚"); status='ng'; }
            else msgs.push("â­• ãƒ«ã‚·ã‚¦ã‚¹å‡ºå¼µOKï¼å›é¿æ€§èƒ½ãŒå„ªç§€ã§ã™ã€‚");
        } else if(out.id === 'murphy') {
            if(out.wp < 20) { msgs.push("âš ï¸ ãƒãƒ¼ãƒ•ã‚£ãƒ¼å‡ºå¼µã¯ã€æ­¦è£…Lv20ã€‘ä»¥ä¸Šæ¨å¥¨ã€‚"); status='ng'; }
            else msgs.push("â­• ãƒãƒ¼ãƒ•ã‚£ãƒ¼å‡ºå¼µOKï¼ç‰©ç†ç›¾ã¨ã—ã¦æ©Ÿèƒ½ã—ã¾ã™ã€‚");
        } else if(out.ur && out.r === 'wall') {
            msgs.push(`â­• ${out.n}(UR)å‡ºå¼µOKï¼é«˜HPã§å„ªç§€ãªå£ã«ãªã‚Šã¾ã™ã€‚`);
        } else if(out.r === 'atk') {
            if(out.ur) { msgs.push(`âš ï¸ ${out.n}ã®å‡ºå¼µã¯ç«åŠ›ä¸è¶³ã®ãŸã‚éæ¨å¥¨ã§ã™ã€‚`); status='ng'; }
            else if(out.wp < 30) { msgs.push(`âš ï¸ ã‚¢ã‚¿ãƒƒã‚«ãƒ¼å‡ºå¼µã¯ã€æ­¦è£…Lv30ã€‘ãŒå¿…è¦ã§ã™ã€‚`); status='ng'; }
            else msgs.push(`ğŸ”¥ ${out.n}å‡ºå¼µOKï¼Lv30ã®ç«åŠ›ã§ã‚´ãƒªæŠ¼ã—å¯èƒ½ã€‚`);
        } else {
            msgs.push(`âš ï¸ ${out.n}ã®å‡ºå¼µãƒ¡ãƒªãƒƒãƒˆã¯è–„ã„ã§ã™ã€‚`); status='ng';
        }
    } else if (maxC < 4) {
        msgs.push("âŒ ãƒãƒ•ãŒä½ã„ã§ã™ã€‚4ä½“ä»¥ä¸Šæƒãˆã¾ã—ã‚‡ã†ã€‚"); status='ng';
    }

    div.className = "advice " + (status==='ok'?'adv-ok':'adv-ng');
    div.innerHTML = msgs.join('<br>');
}

// === AIææ¡ˆãƒ­ã‚¸ãƒƒã‚¯ ===
function generateAiSuggestion() {
    let resultBox = document.getElementById('ai-result');
    let placeH = document.getElementById('ai-placeholder');
    
    let scores = { tank: 0, air: 0, mis: 0 };
    let totalPower = 0;
    let squadComp = { 1:{t:0,a:0,m:0}, 2:{t:0,a:0,m:0}, 3:{t:0,a:0,m:0} };

    for(let s=1; s<=3; s++) {
        for(let p=1; p<=5; p++) {
            let hid = document.getElementById(`h-${s}-${p}`).value;
            let el = document.getElementById(`w-${s}-${p}`);
            let val = el.value === "æœªè§£æ”¾" || el.value === "æœªå®Ÿè£…" ? 0 : parseInt(el.value);
            let wp = val || 0;

            if(hid !== 'empty') {
                let h = HEROES[hid];
                let points = 10 + wp; 
                scores[h.t] += points;
                totalPower += points;
                
                if(h.t==='tank') squadComp[s].t += points;
                else if(h.t==='air') squadComp[s].a += points;
                else if(h.t==='mis') squadComp[s].m += points;
            }
        }
    }

    if(totalPower === 0) {
        resultBox.style.display = 'none';
        placeH.style.display = 'block';
        return;
    }
    
    placeH.style.display = 'none';
    resultBox.style.display = 'block';
    
    let bestFaction = 'tank';
    let s1 = squadComp[1];
    let mainSquadFaction = s1.t >= s1.a && s1.t >= s1.m ? 'tank' : (s1.a >= s1.m ? 'air' : 'mis');

    if(scores.air > scores.tank && scores.air > scores.mis) bestFaction = 'air';
    else if(scores.mis > scores.tank && scores.mis > scores.air) bestFaction = 'mis';
    else if(scores.tank > scores.air && scores.tank > scores.mis) bestFaction = 'tank';
    else bestFaction = mainSquadFaction;

    let mainSquad = 1;
    let maxCompScore = -1;
    for(let s=1; s<=3; s++) {
        let score = (bestFaction==='tank')? squadComp[s].t : (bestFaction==='air')? squadComp[s].a : squadComp[s].m;
        if(score > maxCompScore) { maxCompScore = score; mainSquad = s; }
    }

    let swapAdvice = "";
    let weakest = null;
    let minWp = 999;
    
    for(let p=1; p<=5; p++) {
        let hid = document.getElementById(`h-${mainSquad}-${p}`).value;
        if(hid === 'empty') continue;
        
        let h = HEROES[hid];
        let el = document.getElementById(`w-${mainSquad}-${p}`);
        let wp = el.value==="æœªè§£æ”¾"||el.value==="æœªå®Ÿè£…"? 0 : parseInt(el.value);
        
        if(h.t !== bestFaction) { weakest = h; break; }
        if(wp < minWp) { minWp = wp; weakest = h; }
    }

    if(weakest) {
        let candidates = [];
        for(let s=1; s<=3; s++) {
            if(s === mainSquad) continue;
            for(let p=1; p<=5; p++) {
                let hid = document.getElementById(`h-${s}-${p}`).value;
                if(hid === 'empty') continue;
                let h = HEROES[hid];
                let el = document.getElementById(`w-${s}-${p}`);
                let wp = el.value==="æœªè§£æ”¾"||el.value==="æœªå®Ÿè£…"? 0 : parseInt(el.value);

                // å£ã‚’æ¢ã—ã¦ã„ã‚‹ãªã‚‰å¼·ã„å£ã‚’ã€ãã†ã§ãªã„ãªã‚‰å¼·ã„ã‚­ãƒ£ãƒ©ã‚’
                if(weakest.r === 'wall') {
                    if(h.r === 'wall' && (h.ur || wp >= 20)) candidates.push({ ...h, squad: s, wp: wp });
                } else {
                    if((h.r === 'wall' && (h.ur || wp >= 20)) || (h.r === 'atk' && wp >= 30)) {
                        candidates.push({ ...h, squad: s, wp: wp });
                    }
                }
            }
        }
        
        candidates.sort((a,b) => b.wp - a.wp);
        let bestCand = candidates[0];
        let suggestionText = "";

        if(bestCand) {
            suggestionText = `æ§ãˆã«ã„ã‚‹<b>ã€${bestCand.n}ã€(ç¬¬${bestCand.squad}éƒ¨éšŠ)</b>ã¨å…¥ã‚Œæ›¿ãˆã¦ã¿ã¾ã—ã‚‡ã†ã€‚<br>æ—¢å­˜ã®æˆ¦åŠ›ã‚’æ´»ã‹ã—ã¦å‹ç‡ã‚¢ãƒƒãƒ—ãŒç‹™ãˆã¾ã™ã€‚`;
        } else {
            if(weakest.r === 'wall') {
                suggestionText = `ã“ã“ã«<b>ã€å›é¿ãƒ»ç‰©ç†è€æ€§ãƒ»é«˜HPã€‘ã‚’æŒã¤ä»–å…µç¨®ã®ç›¾å½¹</b>(ãƒ«ã‚·ã‚¦ã‚¹/ãƒãƒ¼ãƒ•ã‚£ãƒ¼/URã‚¹ã‚«ç­‰)ã‚’å…¥ã‚Œã‚‹ã¨å®‰å®šã—ã¾ã™ã€‚`;
            } else {
                suggestionText = `ã“ã“ã«<b>ã€ä»–å…µç¨®ã®è¶…ç«åŠ›ã‚¢ã‚¿ãƒƒã‚«ãƒ¼(æ­¦è£…Lv30)ã€‘</b>ã‚’å…¥ã‚Œã‚‹ã‹ã€<b>ã€ä»–å…µç¨®ã®ç›¾å½¹ã€‘</b>ã‚’å…¥ã‚Œã¦è€ä¹…å¯„ã‚Šã®3-2ç·¨æˆã«ã™ã‚‹ã®ãŒãŠå‹§ã‚ã§ã™ã€‚`;
            }
        }

        swapAdvice = `<div class="swap-candidate">
            <span class="swap-title">ğŸ”„ å…¥ã‚Œæ›¿ãˆå€™è£œ (ç¬¬${mainSquad}éƒ¨éšŠ)</span>
            ç¾åœ¨ã®æ§‹æˆã§ã¯ã€${weakest.n}ã€ãŒå…¥ã‚Œæ›¿ãˆã®ç¬¬ä¸€å€™è£œã§ã™ã€‚<br>${suggestionText}
        </div>`;
    }

    let scoreTxt = `<div class="score-breakdown">ã‚¹ã‚³ã‚¢å†…è¨³: æˆ¦è»Š${scores.tank} / èˆªç©º${scores.air} / ï¾›ï½¹ï¾—ï¾${scores.mis}</div>`;
    let msg = "";
    if(bestFaction === 'tank') {
        msg = `ğŸ’¡ <b>æˆ¦è»Šè»¸ãŒãŠã™ã™ã‚</b><br>æˆ¦è»Šã‚­ãƒ£ãƒ©ã®æˆ¦åŠ›ãŒæœ€ã‚‚é«˜ã„ã§ã™ã€‚ç¬¬${mainSquad}éƒ¨éšŠã‚’ä¸­å¿ƒã«ã€æˆ¦è»Š5ä½“ã¾ãŸã¯4+1ç·¨æˆã‚’çµ„ã¿ã¾ã—ã‚‡ã†ã€‚${swapAdvice}${scoreTxt}`;
    } else if(bestFaction === 'air') {
        msg = `ğŸ’¡ <b>èˆªç©ºæ©Ÿè»¸ãŒãŠã™ã™ã‚</b><br>èˆªç©ºæ©Ÿã®æˆ¦åŠ›ãŒæœ€ã‚‚é«˜ã„ã§ã™ã€‚å¯¾æˆ¦è»Šã§ç„¡åŒã§ãã¾ã™ã€‚ãƒ­ã‚±ãƒ©ãƒ³å¯¾ç­–ã«ç‰©ç†ç›¾ã‚’æ··ãœã‚‹ã®ãŒãƒˆãƒ¬ãƒ³ãƒ‰ã§ã™ã€‚${swapAdvice}${scoreTxt}`;
    } else if(bestFaction === 'mis') {
        msg = `ğŸ’¡ <b>ãƒ­ã‚±ãƒ©ãƒ³è»¸ãŒãŠã™ã™ã‚</b><br>ãƒ­ã‚±ãƒ©ãƒ³ã®æˆ¦åŠ›ãŒæœ€ã‚‚é«˜ã„ã§ã™ã€‚èˆªç©ºæ©Ÿç·¨æˆã‚’ç‹©ã‚‹ã®ã«æœ€é©ã§ã™ã€‚å‰è¡›ã‚’åšãã™ã‚‹ã¨å‹ç‡ãŒä¸ŠãŒã‚Šã¾ã™ã€‚${swapAdvice}${scoreTxt}`;
    }
    
    resultBox.innerHTML = msg;
}

function resetSquads() {
    if(confirm("ç·¨æˆã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ")) {
        for(let s=1; s<=3; s++) for(let p=1; p<=5; p++) {
            document.getElementById(`h-${s}-${p}`).value = 'empty';
            document.getElementById(`w-${s}-${p}`).value = 0;
        }
        for(let s=1; s<=3; s++) updateSquad(s);
    }
}

// --- è£…å‚™ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ ---
function initGearHTML() {
    const makeRow = (prefix) => {
        return GEAR_TYPES.map(g => `
        <div class="g-row">
            <span class="g-label">${GEAR_NAMES[g]}</span>
            <div class="g-input-group">
                <div class="stepper stepper-lv"><button onclick="gearStep('${prefix}${g}Lv', -1)">-</button><input id="${prefix}${g}Lv" value="40" readonly><button onclick="gearStep('${prefix}${g}Lv', 1)">+</button></div>
                <div class="stepper stepper-star"><button onclick="gearStep('${prefix}${g}Star', -1)">-</button><input id="${prefix}${g}Star" data-val="0" value="â˜†â˜†â˜†â˜†â˜†" readonly><button onclick="gearStep('${prefix}${g}Star', 1)">+</button></div>
            </div>
        </div>`).join('');
    };
    document.getElementById('current-gear-rows').innerHTML = makeRow('c');
    document.getElementById('target-gear-rows').innerHTML = makeRow('t');
}

function gearStep(id, d) {
    let el = document.getElementById(id);
    let isStar = id.includes('Star');
    let isWeapon = id.includes('Weapon');

    let v = isStar ? parseInt(el.getAttribute('data-val')) : parseInt(el.value);
    let max = isStar ? 5 : (isWeapon ? 30 : 40); 
    let newVal = Math.min(Math.max(v + d, 0), max);
    
    if(isStar) {
        el.setAttribute('data-val', newVal);
        let s = ""; for(let i=0; i<5; i++) s += i<newVal ? "â˜…":"â˜†";
        el.value = s;
        el.style.color = newVal===5 ? "#e74c3c" : newVal>0 ? "#f39c12" : "#ccc";
    } else {
        el.value = newVal;
    }
    calculateGear();
    saveData();
}

function calculateGear() {
    // è£…å‚™Lv40æœªæº€ã¯â˜…å…¥åŠ›ã‚’ãƒ­ãƒƒã‚¯ã—ã¦0ã«ã™ã‚‹
    ['c', 't'].forEach(p => {
        GEAR_TYPES.forEach(g => {
            let lvEl = document.getElementById(`${p}${g}Lv`);
            let starEl = document.getElementById(`${p}${g}Star`);
            let starWrap = starEl.closest('.stepper');
            if (parseInt(lvEl.value) < 40) {
                starEl.setAttribute('data-val', 0);
                starEl.value = "â˜†â˜†â˜†â˜†â˜†";
                starEl.style.color = "#ccc";
                starWrap.classList.add('disabled');
            } else {
                starWrap.classList.remove('disabled');
            }
        });
    });

    let costUr = 0, costMr = 0;
    const urReq = [0, 5, 15, 30, 50, 50]; 
    const mrReq = [0, 0, 0, 0, 0, 10];
    
    let listHtml = "";
    GEAR_TYPES.forEach(g => {
        let cS = parseInt(document.getElementById(`c${g}Star`).getAttribute('data-val'));
        let tS = parseInt(document.getElementById(`t${g}Star`).getAttribute('data-val'));
        if(tS > cS) {
            let u = urReq[tS] - urReq[cS];
            let m = mrReq[tS] - mrReq[cS];
            costUr += u; costMr += m;
            let txt = [];
            if(u>0) txt.push(`<span style="color:#f39c12">UR${u}</span>`);
            if(m>0) txt.push(`<span style="color:#c0392b">MR${m}</span>`);
            listHtml += `<div class="cost-row"><span>${GEAR_NAMES[g]} â˜…${cS}â†’${tS}</span><span>${txt.join('+')}</span></div>`;
        }
    });
    
    document.getElementById('cost-list').innerHTML = listHtml || "<span style='color:#ccc;'>è¿½åŠ ã‚³ã‚¹ãƒˆãªã—</span>";
    document.getElementById('ft-ur').innerText = costUr;
    document.getElementById('ft-mr').innerText = costMr;

    const calcP = (p) => {
        let wp = parseInt(document.getElementById(`${p}Weapon`).value);
        let m = 1.0;
        let mythics = [];
        
        GEAR_TYPES.forEach(g => {
            let lv = parseInt(document.getElementById(`${p}${g}Lv`).value);
            let st = parseInt(document.getElementById(`${p}${g}Star`).getAttribute('data-val'));
            let base = 1 + (lv * 0.005) + (st * 0.05); 
            if(st===5) { 
                base += 0.1; 
                mythics.push(GEAR_NAMES[g].replace(/[\u231a-\u26ff]/g, ''));
            }
            m *= base;
        });
        m *= (1 + wp * 0.02); 
        return { val: m.toFixed(2), myth: mythics };
    };

    let resC = calcP('c');
    let resT = calcP('t');
    
    document.getElementById('growth-rate').innerText = (resC.val > 0) ? (resT.val / resC.val).toFixed(2) : "1.00";
    
    let dispBuff = (el, arr) => {
        if(arr.length === 0) {
            el.innerHTML = ""; el.classList.remove('active');
        } else {
            el.innerHTML = "<b>ç™ºå‹•ä¸­:</b> " + arr.join(" / "); el.classList.add('active');
        }
    };
    dispBuff(document.getElementById('detail-curr'), resC.myth);
    dispBuff(document.getElementById('detail-tgt'), resT.myth);
}

// --- ä¿å­˜/èª­è¾¼ ---
function saveData() {
    let data = {};
    for(let s=1; s<=3; s++) for(let p=1; p<=5; p++) {
        data[`h-${s}-${p}`] = document.getElementById(`h-${s}-${p}`).value;
        data[`w-${s}-${p}`] = document.getElementById(`w-${s}-${p}`).value;
    }
    ['c','t'].forEach(p => {
        data[`${p}Weapon`] = document.getElementById(`${p}Weapon`).value;
        GEAR_TYPES.forEach(g => {
            data[`${p}${g}Lv`] = document.getElementById(`${p}${g}Lv`).value;
            data[`${p}${g}Star`] = document.getElementById(`${p}${g}Star`).getAttribute('data-val');
        });
    });
    localStorage.setItem('lw_sim_final_layout_v9', JSON.stringify(data));
}

function loadAllData() {
    let saved = localStorage.getItem('lw_sim_final_layout_v9');
    if(saved) {
        let d = JSON.parse(saved);
        for(let s=1; s<=3; s++) for(let p=1; p<=5; p++) {
            let h = d[`h-${s}-${p}`], w = d[`w-${s}-${p}`];
            if(h) document.getElementById(`h-${s}-${p}`).value = h;
            if(w) document.getElementById(`w-${s}-${p}`).value = w;
        }
        ['c','t'].forEach(p => {
            if(d[`${p}Weapon`]) document.getElementById(`${p}Weapon`).value = d[`${p}Weapon`];
            GEAR_TYPES.forEach(g => {
                if(d[`${p}${g}Lv`]) document.getElementById(`${p}${g}Lv`).value = d[`${p}${g}Lv`];
                if(d[`${p}${g}Star`]) gearStep(`${p}${g}Star`, parseInt(d[`${p}${g}Star`])); 
            });
        });
    }
    for(let s=1; s<=3; s++) updateSquad(s);
}

function resetGear() {
    ['c','t'].forEach(p => {
        document.getElementById(`${p}Weapon`).value = 20;
        GEAR_TYPES.forEach(g => {
            document.getElementById(`${p}${g}Lv`).value = 40;
            gearStep(`${p}${g}Star`, -5); 
        });
    });
    calculateGear();
    saveData();
}
</script>
</body>
</html>
