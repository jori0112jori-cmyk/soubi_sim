<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>ãƒ©ã‚¹ãƒˆã‚¦ã‚©ãƒ¼è£…å‚™ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼</title>
<style>
    /* å…¨ä½“ã®ãƒ™ãƒ¼ã‚¹è¨­å®š */
    body { font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue", Arial, sans-serif; background-color: #f0f4f8; color: #333; padding: 10px; padding-bottom: 180px; margin: 0; }
    h1 { font-size: 1.2rem; text-align: center; color: #2c3e50; margin-bottom: 15px; line-height: 1.4; }
    .container { max-width: 1000px; margin: 0 auto; }
    
    .panel { background: #fff; padding: 12px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); margin-bottom: 15px; }
    .grid { display: flex; gap: 12px; flex-wrap: wrap; }
    
    .card { flex: 1; min-width: 100%; background: #fff; padding: 12px 10px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); box-sizing: border-box;}
    @media (min-width: 768px) { .card { min-width: calc(50% - 10px); padding: 20px 15px; } }
    
    .card-before { border-top: 6px solid #7f8c8d; }
    .card-after { border-top: 6px solid #e74c3c; background: linear-gradient(to bottom, #fffafb, #ffffff); }
    .panel-header { display: flex; justify-content: space-between; align-items: center; margin-top: 0; color: #2980b9; border-bottom: 2px solid #ecf0f1; padding-bottom: 8px; font-size: 1rem; }
    
    label { display: block; margin-top: 10px; margin-bottom: 4px; font-weight: 900; font-size: 0.92rem; color: #333; height: 1.2rem; line-height: 1.2rem; white-space: nowrap; overflow: visible; }

    .stepper { display: flex; align-items: center; background: #fff; border: 1px solid #ccd1d9; border-radius: 8px; overflow: hidden; height: 38px; width: 100%; box-sizing: border-box; }
    
    .stepper button { 
        width: 34px; height: 100%; border: none; background: #eef2f5; font-size: 1.3rem; font-weight: bold; color: #34495e; cursor: pointer; touch-action: manipulation; flex-shrink: 0;
    }
    @media (max-width: 380px) { .stepper button { width: 30px; } }

    .stepper input { flex: 1; width: 100%; min-width: 0; text-align: center; border: none; font-size: 16px; font-weight: bold; color: #2c3e50; background: transparent; height: 100%; padding: 0; }
    .stepper input[readonly] { font-size: 15px; letter-spacing: -2px; padding-left: 1px; }

    .stepper.disabled { opacity: 0.4; pointer-events: none; background-color: #ecf0f1; }

    .gear-row { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 5px; align-items: end; }
    
    .result { margin-top: 20px; padding: 15px; border-radius: 10px; text-align: center; border: 1px solid #eee; background-color: #f8f9fa;}
    .res-after { background-color: #faeaeb; border-color: #fadbd8; }
    .score { font-size: 2.2rem; font-weight: bold; margin: 5px 0; font-family: "Arial Black", Arial, sans-serif; letter-spacing: 1px;}
    .score-b { color: #2980b9; } 
    .score-a { color: #c0392b; } 
    
    .detail-text { font-size: 0.8rem; color: #555; line-height: 1.5; text-align: center; padding: 10px; background: #fff; border-radius: 8px; margin-top: 10px; border: 1px solid #e1e8ed; box-shadow: 0 1px 3px rgba(0,0,0,0.02);}
    .res-after .detail-text { border-color: #fadbd8; } 
    .mythic-box { margin-top: 8px; padding-top: 8px; border-top: 1px dashed #ccc; text-align: left; font-size: 0.75rem; line-height: 1.6; }
    
    .diff-wrapper { position: fixed; bottom: 10px; left: 50%; transform: translateX(-50%); width: calc(100% - 20px); max-width: 970px; z-index: 1000; }
    .diff { font-size: 1.15rem; color: #e74c3c; font-weight: bold; text-align: center; padding: 10px 14px; background: rgba(255, 250, 250, 0.95); backdrop-filter: blur(5px); border-radius: 12px; border: 2px solid #fadbd8; box-shadow: 0 5px 15px rgba(231, 76, 60, 0.15); }
    .reset-btn { font-size: 0.65rem; background: #ecf0f1; color: #7f8c8d; border: none; padding: 3px 6px; border-radius: 4px; cursor: pointer;}
    
    .prio-badge { display: inline-block; padding: 1px 5px; border-radius: 4px; color: #fff; font-size: 0.65rem; font-weight: bold; margin-left: 3px; vertical-align: middle; line-height: 1.2; letter-spacing: 0; }
    .guide-select { width: 100%; padding: 8px; border-radius: 6px; border: 1px solid #ccd1d9; font-size: 0.9rem; font-weight: bold; color: #2c3e50; background: #f8f9fa; margin-top: 5px; }
</style>
</head>
<body>

<div class="container">
    <h1>è£…å‚™ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼<br><span style="font-size: 0.8rem; color: #7f8c8d;"></span></h1>

    <div class="panel">
        <h3 class="panel-header">ğŸ¢ å…±é€šè¨­å®š <button class="reset-btn" onclick="resetAllData()">ãƒªã‚»ãƒƒãƒˆ</button></h3>
        
        <div style="display: flex; gap: 15px; flex-wrap: wrap;">
            <div style="flex: 1; min-width: 140px;">
                <label>æœ¬éƒ¨ãƒ¬ãƒ™ãƒ« (MAX 35)</label>
                <div class="stepper" style="max-width: 150px;">
                    <button type="button" onclick="stepHQ(-1)">-</button>
                    <input type="number" id="hqLevel" value="30" min="1" max="35" onchange="updateHQ()">
                    <button type="button" onclick="stepHQ(1)">+</button>
                </div>
            </div>
            
            <div style="flex: 2; min-width: 200px;">
                <label>ğŸ¯ èµ¤è£…å‚™ã¸ã®å¼·åŒ–å„ªå…ˆåº¦</label>
                <select id="roleType" class="guide-select" onchange="updatePriority(); saveAllData();">
                    <option value="none">ã‚¬ã‚¤ãƒ‰ã‚’è¡¨ç¤ºã—ãªã„</option>
                    <option value="attacker">âš”ï¸ ã‚¢ã‚¿ãƒƒã‚«ãƒ¼ç”¨ (ã‚­ãƒ³ãƒãƒªãƒ¼ç­‰)</option>
                    <option value="tank">ğŸ›¡ï¸ ã‚¿ãƒ³ã‚¯ç”¨ (ãƒãƒ¼ãƒ•ã‚£ãƒ¼ç­‰)</option>
                </select>
            </div>
        </div>
        
        <div id="roleDesc" style="font-size: 0.75rem; color: #555; margin-top: 10px; padding: 8px; background: #fffbf2; border-radius: 6px; border: 1px dashed #e5cc98; display: none; line-height: 1.5;"></div>
    </div>

    <div class="grid">
        <div class="card card-before">
            <h3 class="panel-header" style="color:#7f8c8d;">1. ç¾åœ¨</h3>
            <div class="gear-row">
                <div><label id="cLevelLabel">ğŸ‘¤ Lv</label><div class="stepper"><button onclick="step('cLevel', -1)">-</button><input type="number" id="cLevel" value="150" min="1" onchange="calculate()"><button onclick="step('cLevel', 1)">+</button></div></div>
                <div><label>âš”ï¸ æ­¦è£…Lv</label><div class="stepper"><button onclick="step('cWeapon', -1)">-</button><input type="number" id="cWeapon" value="20" min="0" max="30" onchange="calculate()"><button onclick="step('cWeapon', 1)">+</button></div></div>
            </div>
            <div style="margin-top:15px; padding-top:10px; border-top:1px dashed #ccc;">
                <div class="gear-row">
                    <div><label>ğŸ”« ãƒ¬ãƒ¼ãƒ«ã‚¬ãƒ³ Lv</label><div class="stepper"><button onclick="step('cGunLv', -1)">-</button><input type="number" id="cGunLv" value="40" min="0" max="40" onchange="calculate()"><button onclick="step('cGunLv', 1)">+</button></div></div>
                    <div><label>â˜…æ®µéš</label><div class="stepper"><button onclick="step('cGunStar', -1)">-</button><input type="text" id="cGunStar" data-val="0" value="â˜†â˜†â˜†â˜†â˜†" readonly><button onclick="step('cGunStar', 1)">+</button></div></div>
                </div>
                <div class="gear-row">
                    <div><label>ğŸ’¾ ãƒãƒƒãƒ— Lv</label><div class="stepper"><button onclick="step('cDataLv', -1)">-</button><input type="number" id="cDataLv" value="40" min="0" max="40" onchange="calculate()"><button onclick="step('cDataLv', 1)">+</button></div></div>
                    <div><label>â˜…æ®µéš</label><div class="stepper"><button onclick="step('cDataStar', -1)">-</button><input type="text" id="cDataStar" data-val="0" value="â˜†â˜†â˜†â˜†â˜†" readonly><button onclick="step('cDataStar', 1)">+</button></div></div>
                </div>
                <div class="gear-row">
                    <div><label>ğŸ›¡ï¸ è£…ç”² Lv</label><div class="stepper"><button onclick="step('cArmorLv', -1)">-</button><input type="number" id="cArmorLv" value="40" min="0" max="40" onchange="calculate()"><button onclick="step('cArmorLv', 1)">+</button></div></div>
                    <div><label>â˜…æ®µéš</label><div class="stepper"><button onclick="step('cArmorStar', -1)">-</button><input type="text" id="cArmorStar" data-val="0" value="â˜†â˜†â˜†â˜†â˜†" readonly><button onclick="step('cArmorStar', 1)">+</button></div></div>
                </div>
                <div class="gear-row">
                    <div><label>ğŸ“¡ ãƒ¬ãƒ¼ãƒ€ãƒ¼ Lv</label><div class="stepper"><button onclick="step('cRadarLv', -1)">-</button><input type="number" id="cRadarLv" value="40" min="0" max="40" onchange="calculate()"><button onclick="step('cRadarLv', 1)">+</button></div></div>
                    <div><label>â˜…æ®µéš</label><div class="stepper"><button onclick="step('cRadarStar', -1)">-</button><input type="text" id="cRadarStar" data-val="0" value="â˜†â˜†â˜†â˜†â˜†" readonly><button onclick="step('cRadarStar', 1)">+</button></div></div>
                </div>
            </div>
            
            <div class="result res-before">
                <div style="font-size: 0.85rem; color: #7f8c8d; font-weight: bold;">åŸºç¤ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹(è£…å‚™ãªã—)ã®</div>
                <div class="score score-b"><span id="scoreBefore">1.00</span> <span style="font-size: 1.2rem;">å€</span></div>
                <div class="detail-text" id="detailBefore"></div>
            </div>
        </div>

        <div class="card card-after">
            <h3 class="panel-header" style="color:#c0392b;">2. ç›®æ¨™</h3>
            <div class="gear-row">
                <div><label id="tLevelLabel">ğŸ‘¤ Lv</label><div class="stepper"><button onclick="step('tLevel', -1)">-</button><input type="number" id="tLevel" value="150" min="1" onchange="calculate()"><button onclick="step('tLevel', 1)">+</button></div></div>
                <div><label>âš”ï¸ æ­¦è£…Lv</label><div class="stepper"><button onclick="step('tWeapon', -1)">-</button><input type="number" id="tWeapon" value="20" min="0" max="30" onchange="calculate()"><button onclick="step('tWeapon', 1)">+</button></div></div>
            </div>
            <div style="margin-top:15px; padding-top:10px; border-top:1px dashed #ccc;">
                <div class="gear-row">
                    <div><label>ğŸ”« ãƒ¬ãƒ¼ãƒ«ã‚¬ãƒ³ Lv <span id="prioGun" class="prio-badge" style="display:none;"></span></label><div class="stepper"><button onclick="step('tGunLv', -1)">-</button><input type="number" id="tGunLv" value="40" min="0" max="40" onchange="calculate()"><button onclick="step('tGunLv', 1)">+</button></div></div>
                    <div><label>â˜…æ®µéš</label><div class="stepper"><button onclick="step('tGunStar', -1)">-</button><input type="text" id="tGunStar" data-val="2" value="â˜…â˜…â˜†â˜†â˜†" readonly><button onclick="step('tGunStar', 1)">+</button></div></div>
                </div>
                <div class="gear-row">
                    <div><label>ğŸ’¾ ãƒãƒƒãƒ— Lv <span id="prioData" class="prio-badge" style="display:none;"></span></label><div class="stepper"><button onclick="step('tDataLv', -1)">-</button><input type="number" id="tDataLv" value="40" min="0" max="40" onchange="calculate()"><button onclick="step('tDataLv', 1)">+</button></div></div>
                    <div><label>â˜…æ®µéš</label><div class="stepper"><button onclick="step('tDataStar', -1)">-</button><input type="text" id="tDataStar" data-val="0" value="â˜†â˜†â˜†â˜†â˜†" readonly><button onclick="step('tDataStar', 1)">+</button></div></div>
                </div>
                <div class="gear-row">
                    <div><label>ğŸ›¡ï¸ è£…ç”² Lv <span id="prioArmor" class="prio-badge" style="display:none;"></span></label><div class="stepper"><button onclick="step('tArmorLv', -1)">-</button><input type="number" id="tArmorLv" value="40" min="0" max="40" onchange="calculate()"><button onclick="step('tArmorLv', 1)">+</button></div></div>
                    <div><label>â˜…æ®µéš</label><div class="stepper"><button onclick="step('tArmorStar', -1)">-</button><input type="text" id="tArmorStar" data-val="0" value="â˜†â˜†â˜†â˜†â˜†" readonly><button onclick="step('tArmorStar', 1)">+</button></div></div>
                </div>
                <div class="gear-row">
                    <div><label>ğŸ“¡ ãƒ¬ãƒ¼ãƒ€ãƒ¼ Lv <span id="prioRadar" class="prio-badge" style="display:none;"></span></label><div class="stepper"><button onclick="step('tRadarLv', -1)">-</button><input type="number" id="tRadarLv" value="40" min="0" max="40" onchange="calculate()"><button onclick="step('tRadarLv', 1)">+</button></div></div>
                    <div><label>â˜…æ®µéš</label><div class="stepper"><button onclick="step('tRadarStar', -1)">-</button><input type="text" id="tRadarStar" data-val="5" value="â˜…â˜…â˜…â˜…â˜…" readonly><button onclick="step('tRadarStar', 1)">+</button></div></div>
                </div>
            </div>
            
            <div class="result res-after">
                <div style="font-size: 0.85rem; color: #c0392b; font-weight: bold;">åŸºç¤ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹(è£…å‚™ãªã—)ã®</div>
                <div class="score score-a"><span id="scoreAfter">1.00</span> <span style="font-size: 1.2rem;">å€</span></div>
                <div class="detail-text" id="detailAfter"></div>
            </div>
        </div>
    </div>
</div>

<div class="diff-wrapper">
    <div class="diff" id="growthDiff">
        <div style="margin-bottom: 5px;">ä»Šã®å¼·ã•ã® ç´„ <span id="growthNum" style="font-size:1.5rem; padding: 0 4px;">1.00</span> å€ã«ï¼</div>
        
        <div id="costDisplay" style="font-size: 0.85rem; color: #555; margin-top: 8px; border-top: 1px dashed #fadbd8; padding-top: 10px; font-weight: normal; display: none; text-align: left;">
            <div style="text-align: center; margin-bottom: 8px;">
                <span style="font-weight:bold; color:#d35400;">ğŸ†™ ç›®æ¨™ã¾ã§ã«å¿…è¦ãªè£…å‚™ãƒ¬ã‚·ãƒ”(åˆè¨ˆ)</span><br>
                UR(é‡‘): <b id="urCost" style="color:#f39c12; font-size:1.2rem;">0</b> æš ã€€ MR(èµ¤): <b id="mrCost" style="color:#e74c3c; font-size:1.2rem;">0</b> æš
            </div>
            
            <div id="costBreakdown" style="font-size: 0.8rem; background: #fff; padding: 8px; border-radius: 6px; border: 1px solid #eee; margin-bottom: 10px;">
                </div>
            
            <div style="font-size: 0.7rem; color: #777; text-align: center; line-height: 1.5;">
                <b style="color: #555;">ã€1æ®µéšã”ã¨ã®å¿…è¦æ•° æ—©è¦‹è¡¨ã€‘</b><br>
                â˜…0â†’1: <span style="color:#f39c12; font-weight:bold;">5æš</span> / â˜…1â†’2: <span style="color:#f39c12; font-weight:bold;">10æš</span> / â˜…2â†’3: <span style="color:#f39c12; font-weight:bold;">15æš</span><br>
                â˜…3â†’4: <span style="color:#f39c12; font-weight:bold;">20æš</span> / â˜…4â†’5: <span style="color:#e74c3c; font-weight:bold;">èµ¤10æš</span>
            </div>
        </div>
    </div>
</div>

<script>
function updatePriority() {
    let role = document.getElementById('roleType').value;
    let desc = document.getElementById('roleDesc');
    let bGun = document.getElementById('prioGun'), bData = document.getElementById('prioData');
    let bArmor = document.getElementById('prioArmor'), bRadar = document.getElementById('prioRadar');
    
    [bGun, bData, bArmor, bRadar].forEach(b => b.style.display = 'none');

    if (role === 'attacker') {
        bGun.innerText = 'å„ªå…ˆ â‘ '; bGun.style.display = 'inline-block'; bGun.style.background = '#e74c3c';
        bData.innerText = 'å„ªå…ˆ â‘¡'; bData.style.display = 'inline-block'; bData.style.background = '#e67e22';
        bRadar.innerText = 'â‘¢'; bRadar.style.display = 'inline-block'; bRadar.style.background = '#95a5a6';
        bArmor.innerText = 'â‘£'; bArmor.style.display = 'inline-block'; bArmor.style.background = '#bdc3c7';
        desc.innerHTML = "<b>ğŸ’¡ ã€ã‚¢ã‚¿ãƒƒã‚«ãƒ¼(ç«åŠ›å½¹)ã®ã‚»ã‚ªãƒªãƒ¼ã€‘</b><br>ç«åŠ›ãŒã™ã¹ã¦ï¼æœ€å„ªå…ˆã§<b>ã€Œãƒ¬ãƒ¼ãƒ«ã‚¬ãƒ³ã€</b>ã‚’èµ¤(â˜…5)ã«ã—ã¦ã€ç«åŠ›+10%ã€ã®ãƒ‘ãƒƒã‚·ãƒ–ã‚’è§£æ”¾ã€‚æ¬¡ã«æ”»æ’ƒã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãŒä¼¸ã³ã‚‹<b>ã€Œãƒãƒƒãƒ—ã€</b>ã‚’å¼·åŒ–ã™ã‚‹ã®ãŒä¸–ç•Œå…±é€šã®é‰„æ¿ã§ã™ã€‚";
        desc.style.display = 'block';
    } else if (role === 'tank') {
        bRadar.innerText = 'å„ªå…ˆ â‘ '; bRadar.style.display = 'inline-block'; bRadar.style.background = '#2980b9';
        bArmor.innerText = 'å„ªå…ˆ â‘¡'; bArmor.style.display = 'inline-block'; bArmor.style.background = '#3498db';
        bData.innerText = 'â‘¢'; bData.style.display = 'inline-block'; bData.style.background = '#95a5a6';
        bGun.innerText = 'â‘£'; bGun.style.display = 'inline-block'; bGun.style.background = '#bdc3c7';
        desc.innerHTML = "<b>ğŸ’¡ ã€ã‚¿ãƒ³ã‚¯(ç›¾å½¹)ã®ã‚»ã‚ªãƒªãƒ¼ã€‘</b><br>å‰ç·šã‚’ç¶­æŒã™ã‚‹ç”Ÿå­˜åŠ›ãŒå‘½ã€‚æœ€å„ªå…ˆã§<b>ã€Œãƒ¬ãƒ¼ãƒ€ãƒ¼ã€</b>ã‚’èµ¤(â˜…5)ã«ã—ã¦ã€ä¼šå¿ƒè¢«ãƒ€ãƒ¡30%æ¸›ã€ã‚’è§£æ”¾ã€‚æ¬¡ã«ã€ä¼šå¿ƒç‡15%æ¸›ã€ã®<b>ã€Œè£…ç”²ã€</b>ã‚’å¼·åŒ–ã—ã¦ã‚«ãƒã‚«ãƒã«ã—ã¾ã—ã‚‡ã†ã€‚";
        desc.style.display = 'block';
    } else {
        desc.style.display = 'none';
    }
}

function saveAllData() {
    const data = { roleType: document.getElementById('roleType').value };
    document.querySelectorAll('input').forEach(input => {
        data[input.id] = input.id.includes('Star') ? input.getAttribute('data-val') : input.value;
    });
    localStorage.setItem('lastwar_sim_data', JSON.stringify(data));
}

function loadAllData() {
    const saved = localStorage.getItem('lastwar_sim_data');
    if (!saved) return false;
    const data = JSON.parse(saved);
    if (data.roleType) { document.getElementById('roleType').value = data.roleType; updatePriority(); }
    for (let id in data) {
        let el = document.getElementById(id);
        if (el && id !== 'roleType') {
            if (id.includes('Star')) { el.setAttribute('data-val', data[id]); updateStarDisplay(el, parseInt(data[id])); }
            else { el.value = data[id]; }
        }
    }
    return true;
}

function resetAllData() {
    if(confirm("ãƒ‡ãƒ¼ã‚¿ã‚’åˆæœŸåŒ–ã—ã¾ã™ã‹ï¼Ÿ")) { localStorage.removeItem('lastwar_sim_data'); location.reload(); }
}

function animateValue(obj, start, end, duration, isRatio = false) {
    let startTimestamp = null;
    const step = (timestamp) => {
        if (!startTimestamp) startTimestamp = timestamp;
        const progress = Math.min((timestamp - startTimestamp) / duration, 1);
        const easeOut = 1 - Math.pow(1 - progress, 3);
        let current = start + (end - start) * easeOut;
        obj.innerHTML = isRatio ? current.toFixed(2) : Math.floor(current).toLocaleString();
        if (progress < 1) window.requestAnimationFrame(step);
        else obj.innerHTML = isRatio ? end.toFixed(2) : Math.floor(end).toLocaleString();
    };
    window.requestAnimationFrame(step);
}

function updateStarDisplay(el, val) {
    let stars = ""; for (let i = 0; i < 5; i++) stars += (i < val) ? "â˜…" : "â˜†";
    el.value = stars;
    if (val === 5) el.style.color = "#e74c3c";
    else if (val > 0) el.style.color = "#f39c12";
    else el.style.color = "#95a5a6";
}

function stepHQ(delta) {
    let el = document.getElementById('hqLevel');
    el.value = Math.min(Math.max(parseInt(el.value) + delta, 1), 35);
    updateHQ(); 
}

function updateHQ() {
    let hqVal = parseInt(document.getElementById('hqLevel').value) || 30;
    let maxHL = hqVal * 5;
    
    ['cLevel', 'tLevel'].forEach(id => {
        let el = document.getElementById(id);
        el.setAttribute('max', maxHL);
        document.getElementById(id + 'Label').innerText = `ğŸ‘¤ Lv (1~${maxHL})`;
        if (parseInt(el.value) > maxHL) el.value = maxHL;
    });
    
    calculate();
}

function step(id, delta) {
    let el = document.getElementById(id);
    let isStar = id.includes('Star');
    let val = parseInt(isStar ? el.getAttribute('data-val') : el.value) || 0;
    let min = parseInt(el.getAttribute('min')) || 0;
    let max = parseInt(el.getAttribute('max')) || 999;
    
    let newVal = Math.min(Math.max(val + delta, min), max);
    
    if (isStar) { el.setAttribute('data-val', newVal); updateStarDisplay(el, newVal); }
    else { el.value = newVal; }
    
    calculate();
}

function getGearMultiplier(gearLevel, stars, type) {
    let baseBoost = 0.025 + (gearLevel * 0.00125);
    let starBoost = [0, 0.025, 0.075, 0.1, 0.15, 0.23][stars] || 0;
    let passiveMulti = 1.0;
    if (stars === 5) {
        if (type === 'gun') passiveMulti = 1.10;
        if (type === 'radar') passiveMulti = 1.30;
        if (type === 'armor') passiveMulti = 1.15;
        if (type === 'data') passiveMulti = 1.05;
    }
    return { statMulti: 1.0 + baseBoost + starBoost, passiveMulti: passiveMulti };
}

let lastB_multi = 1.00, lastA_multi = 1.00, lastRatio = 1.00;

function calculate() {
    const gears = ['Gun', 'Data', 'Armor', 'Radar'];
    const gearNames = { 'Gun': 'ğŸ”« ãƒ¬ãƒ¼ãƒ«ã‚¬ãƒ³', 'Data': 'ğŸ’¾ ãƒãƒƒãƒ—', 'Armor': 'ğŸ›¡ï¸ è£…ç”²', 'Radar': 'ğŸ“¡ ãƒ¬ãƒ¼ãƒ€ãƒ¼' };
    
    const urCumulative = [0, 5, 15, 30, 50, 50]; 
    const mrCumulative = [0, 0, 0, 0, 0, 10];
    let totalUrReq = 0, totalMrReq = 0;
    let breakdownHtml = "";

    ['c', 't'].forEach(p => {
        gears.forEach(g => {
            let lvEl = document.getElementById(p+g+'Lv');
            let sEl = document.getElementById(p+g+'Star');
            if (parseInt(lvEl.value) < 40) { sEl.setAttribute('data-val', 0); updateStarDisplay(sEl, 0); sEl.closest('.stepper').classList.add('disabled'); }
            else sEl.closest('.stepper').classList.remove('disabled');
        });
    });
    
    gears.forEach(g => {
        let cLv = parseInt(document.getElementById('c'+g+'Lv').value);
        let cStar = cLv >= 40 ? parseInt(document.getElementById('c'+g+'Star').getAttribute('data-val')) : 0;
        
        let tLv = parseInt(document.getElementById('t'+g+'Lv').value);
        let tStar = tLv >= 40 ? parseInt(document.getElementById('t'+g+'Star').getAttribute('data-val')) : 0;
        
        if (tStar > cStar) {
            let urReq = urCumulative[tStar] - urCumulative[cStar];
            let mrReq = mrCumulative[tStar] - mrCumulative[cStar];
            totalUrReq += urReq;
            totalMrReq += mrReq;
            
            let reqText = [];
            if (urReq > 0) reqText.push(`<span style="color:#f39c12; font-weight:bold;">UR ${urReq}æš</span>`);
            if (mrReq > 0) reqText.push(`<span style="color:#e74c3c; font-weight:bold;">MR ${mrReq}æš</span>`);
            
            breakdownHtml += `<div style="margin-bottom: 3px;">${gearNames[g]} : â˜…${cStar} â†’ â˜…${tStar} (${reqText.join(' ï¼‹ ')})</div>`;
        }
    });
    
    let costDiv = document.getElementById("costDisplay");
    if (totalUrReq > 0 || totalMrReq > 0) {
        document.getElementById("urCost").innerText = totalUrReq;
        document.getElementById("mrCost").innerText = totalMrReq;
        document.getElementById("costBreakdown").innerHTML = breakdownHtml;
        costDiv.style.display = "block";
    } else {
        costDiv.style.display = "none";
    }

    const calc = (p) => {
        let lv = parseInt(document.getElementById(p+'Level').value), wp = parseInt(document.getElementById(p+'Weapon').value);
        let baseStat = (lv / 175) * 1000;
        let m = gears.map(g => getGearMultiplier(parseInt(document.getElementById(p+g+'Lv').value), parseInt(document.getElementById(p+g+'Star').getAttribute('data-val')), g.toLowerCase()));
        
        let gearStat = m[0].statMulti * m[1].statMulti * ((m[2].statMulti + m[3].statMulti)/2);
        let gearPass = m.reduce((acc, cur) => acc * cur.passiveMulti, 1);
        let wpMulti = (1.0 + (wp * 0.01)) * ([1, 1.05, 1.2, 1.4][Math.floor(wp/10)] || 1);
        let totalM = gearStat * gearPass * wpMulti;
        
        let activeMythics = [];
        if (m[0].passiveMulti > 1) activeMythics.push("ãƒ¬ãƒ¼ãƒ«ã‚¬ãƒ³ (+10%ç«åŠ›)");
        if (m[1].passiveMulti > 1) activeMythics.push("ãƒãƒƒãƒ— (ä¸åˆ©ãƒ€ãƒ¡5%æ¸›)");
        if (m[2].passiveMulti > 1) activeMythics.push("è£…ç”² (ä¼šå¿ƒç‡15%æ¸›)");
        if (m[3].passiveMulti > 1) activeMythics.push("ãƒ¬ãƒ¼ãƒ€ãƒ¼ (ä¼šå¿ƒè¢«ãƒ€ãƒ¡30%æ¸›)");
        let mythicText = activeMythics.length > 0 ? "<div class='mythic-box'><span style='color:#e74c3c;'><b>â˜…5 èµ¤ãƒ‘ãƒƒã‚·ãƒ–ç™ºå‹•ä¸­ï¼š</b></span><br>ãƒ»" + activeMythics.join("<br>ãƒ»") + "</div>" : "";
        
        return { score: baseStat * totalM, base: Math.round(baseStat), multi: totalM, mythicText: mythicText };
    };
    
    let resB = calc('c'), resA = calc('t');
    
    animateValue(document.getElementById("scoreBefore"), lastB_multi, resB.multi, 400, true);
    animateValue(document.getElementById("scoreAfter"), lastA_multi, resA.multi, 400, true);
    
    document.getElementById("detailBefore").innerHTML = `
        <div style="color: #444; font-weight: bold;">åŸºç¤ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: ${resB.base}</div>
        <div style="font-size: 0.7rem; color: #7f8c8d; margin-top: 2px;">(â€»è£…å‚™ã‚„æ­¦è£…ã‚’å¤–ã—ãŸç´ ã®æ•°å€¤)</div>
        ${resB.mythicText}
    `;
    document.getElementById("detailAfter").innerHTML = `
        <div style="color: #444; font-weight: bold;">åŸºç¤ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: ${resA.base}</div>
        <div style="font-size: 0.7rem; color: #7f8c8d; margin-top: 2px;">(â€»è£…å‚™ã‚„æ­¦è£…ã‚’å¤–ã—ãŸç´ ã®æ•°å€¤)</div>
        ${resA.mythicText}
    `;
    
    let currentRatio = (resB.score > 0) ? (resA.score / resB.score) : 1.00;
    animateValue(document.getElementById("growthNum"), lastRatio, currentRatio, 400, true);
    
    lastB_multi = resB.multi; lastA_multi = resA.multi; lastRatio = currentRatio;
    saveAllData();
}
window.onload = () => { 
    if (!loadAllData()) { updateHQ(); updatePriority(); }
    else { updateHQ(); }
};
</script>
</body>
</html>
