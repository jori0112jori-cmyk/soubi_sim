<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>ãƒ©ã‚¹ãƒˆã‚¦ã‚©ãƒ¼è‚²æˆã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼</title>
<style>
    /* === ãƒ™ãƒ¼ã‚¹è¨­å®š === */
    body { font-family: "Helvetica Neue", Arial, "Hiragino Kaku Gothic ProN", "Hiragino Sans", Meiryo, sans-serif; background-color: #f4f6f8; color: #2c3e50; padding: 12px 10px 120px; margin: 0; font-size: 14px; line-height: 1.5; -webkit-font-smoothing: antialiased; }
    h1 { font-size: 1.25rem; text-align: center; color: #1a252f; margin: 5px 0 15px; font-weight: 900; letter-spacing: 0.5px; }
    .container { max-width: 900px; margin: 0 auto; }
    
    @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

    /* === UIã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ === */
    .tabs { display: flex; background: #e2e8f0; border-radius: 10px; padding: 4px; margin-bottom: 18px; }
    .tab-btn { flex: 1; padding: 12px 0; text-align: center; font-size: 0.95rem; font-weight: bold; color: #64748b; cursor: pointer; border-radius: 8px; transition: all 0.2s ease; }
    .tab-btn.active { background: #fff; color: #2563eb; box-shadow: 0 2px 6px rgba(0,0,0,0.05); }
    .tab-content { display: none; }
    .tab-content.active { display: block; animation: fadeIn 0.3s ease-out; }

    .panel { background: #fff; padding: 15px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.04); margin-bottom: 15px; border: 1px solid #edf2f7; }
    .panel-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #f8fafc; padding-bottom: 10px; margin-bottom: 12px; font-size: 1rem; font-weight: 900; color: #1e293b; }
    .reset-btn { font-size: 0.75rem; background: #fff; color: #64748b; border: 1px solid #cbd5e1; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-weight: bold; transition: 0.2s; }
    .reset-btn:active { background: #f1f5f9; }

    /* === AIææ¡ˆ === */
    .ai-panel { background: linear-gradient(135deg, #ffffff, #f8fafc); border-left: 5px solid #3b82f6; }
    .route-panel { background: linear-gradient(135deg, #ffffff, #fdf4ff); border-left: 5px solid #c026d3; }
    .ai-title { color: #1d4ed8; font-weight: 900; display: flex; align-items: center; justify-content: space-between; gap: 6px; font-size: 1.05rem; margin-bottom: 10px; flex-wrap: wrap; }
    .route-title { color: #a21caf; font-weight: 900; display: flex; align-items: center; gap: 6px; font-size: 1.05rem; margin-bottom: 10px; }
    .suggestion-box { background: #fff; border-radius: 8px; padding: 15px; font-size: 0.9rem; line-height: 1.6; border: 1px solid #e2e8f0; color: #334155; box-shadow: 0 2px 4px rgba(0,0,0,0.02); }
    .swap-candidate { margin-top: 12px; padding-top: 12px; border-top: 1px dashed #cbd5e1; background: #fffbeb; padding: 15px; border-radius: 10px; border: 1px solid #fde68a; color: #475569; }
    .swap-title { font-weight: 900; color: #d97706; display: block; margin-bottom: 12px; font-size: 1rem; border-bottom: 2px dotted #fcd34d; padding-bottom: 8px; }
    .score-breakdown { font-size: 0.8rem; color: #64748b; margin-top: 12px; text-align: center; background: #f8fafc; padding: 8px 12px; border-radius: 8px; border: 1px solid #e2e8f0; font-weight: bold;}
    .apply-btn { background: linear-gradient(to right, #2563eb, #1d4ed8); color: #fff; border: none; padding: 14px 20px; border-radius: 30px; font-weight: bold; cursor: pointer; box-shadow: 0 4px 10px rgba(37,99,235,0.25); font-size: 0.95rem; width: 100%; max-width: 300px; transition: transform 0.1s, box-shadow 0.1s; display: block; margin: 18px auto 5px; letter-spacing: 0.5px;}
    .apply-btn:active { transform: translateY(2px); box-shadow: 0 2px 5px rgba(37,99,235,0.2); }
    
    /* è‚²æˆãƒ«ãƒ¼ãƒˆç”¨ã®ã‚¹ã‚¿ã‚¤ãƒ«è¿½åŠ  */
    .route-badge-air { background: #eff6ff; color: #1d4ed8; border: 1px solid #bfdbfe; padding: 4px 10px; border-radius: 6px; font-weight: bold; font-size: 0.8rem; display: inline-block; margin-bottom: 8px; }
    .route-badge-tank { background: #fffbeb; color: #b45309; border: 1px solid #fde68a; padding: 4px 10px; border-radius: 6px; font-weight: bold; font-size: 0.8rem; display: inline-block; margin-bottom: 8px; }
    .route-highlight { color: #c026d3; font-weight: 900; font-size: 0.95rem; }

    /* === éƒ¨éšŠç·¨æˆ === */
    .squad-section { border: 1px solid #e2e8f0; border-radius: 10px; overflow: hidden; margin-bottom: 15px; background: #fff; box-shadow: 0 2px 6px rgba(0,0,0,0.02); }
    .squad-header { background: #f8fafc; padding: 12px 15px; font-weight: 900; color: #334155; display: flex; justify-content: space-between; align-items: center; cursor: pointer; font-size: 0.95rem; border-bottom: 1px solid #e2e8f0; transition: background 0.2s; }
    .squad-header:active { background: #f1f5f9; }
    .squad-body { padding: 15px; display: none; background: #fff; }
    .squad-body.open { display: block; animation: fadeIn 0.2s ease-out; }
    
    .hero-slot { display: flex; gap: 8px; margin-bottom: 10px; align-items: center; padding: 8px; border-radius: 8px; border: 1px solid #e2e8f0; background: #fafafa;}
    .slot-front { background-color: #fffbeb; border-left: 4px solid #f59e0b; }
    .slot-back { background-color: #eff6ff; border-left: 4px solid #3b82f6; }
    .slot-bench { background-color: #f8fafc; border-left: 4px solid #94a3b8; }
    .pos-badge { font-size: 0.7rem; font-weight: bold; padding: 4px 0; width: 36px; text-align: center; border-radius: 4px; color: #fff; flex-shrink: 0; }
    .badge-front { background-color: #f59e0b; }
    .badge-back { background-color: #3b82f6; }
    .badge-bench { background-color: #94a3b8; }

    .hero-select { flex: 1; min-width: 110px; padding: 10px 6px; border-radius: 6px; border: 1px solid #cbd5e1; font-size: 0.95rem; font-weight: bold; color: #1e293b; background: #fff; text-overflow: ellipsis; white-space: nowrap; overflow: hidden; appearance: none; background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%2364748b' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e"); background-repeat: no-repeat; background-position: right 8px center; background-size: 14px; padding-right: 24px; transition: border-color 0.2s;}
    .hero-select:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 2px rgba(59,130,246,0.2); }
    optgroup { font-weight: bold; background: #f8fafc; color: #475569; }
    
    .wp-wrap { display: flex; align-items: center; gap: 4px; flex-shrink: 0; }
    .wp-label { font-size: 0.7rem; color: #64748b; font-weight: bold; }
    .stepper { display: flex; align-items: center; background: #fff; border: 1px solid #cbd5e1; border-radius: 6px; overflow: hidden; height: 36px; box-shadow: inset 0 1px 2px rgba(0,0,0,0.02);}
    .stepper button { width: 30px; height: 100%; border: none; background: #f1f5f9; font-size: 1.1rem; font-weight: bold; color: #475569; cursor: pointer; padding: 0; flex-shrink: 0; transition: background 0.1s;}
    .stepper button:active { background: #e2e8f0; }
    .stepper input { flex: 1; width: 100%; min-width: 0; text-align: center; border: none; font-size: 0.95rem; font-weight: 900; padding: 0; background: transparent; color: #1e293b;}
    .stepper.disabled { background: #e2e8f0; opacity: 0.6; pointer-events: none; }
    .stepper.disabled input { color: #94a3b8; font-size: 0.85rem; }

    /* === é™£å½¢ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ« === */
    .visual-area { margin-top: 15px; padding-top: 15px; border-top: 1px dashed #cbd5e1; background: #f8fafc; border-radius: 8px; padding: 12px; }
    .visual-label { font-size: 0.75rem; color: #64748b; text-align: center; margin-bottom: 8px; font-weight: bold; display: block; letter-spacing: 0.5px;}
    .visual-grid { display: flex; flex-direction: column; gap: 8px; }
    .v-row-front, .v-row-back { display: flex; justify-content: center; gap: 10px; }
    
    .hero-card { width: 30%; max-width: 90px; padding: 6px 2px; text-align: center; border-radius: 8px; border: 1px solid #e2e8f0; box-shadow: 0 2px 4px rgba(0,0,0,0.04); background: #fff; min-height: 54px; height: auto; display: flex; flex-direction: column; justify-content: center; align-items: center; position: relative; }
    .card-tank { background: #fffbeb; border-color: #fde68a; color: #b45309; }
    .card-air { background: #eff6ff; border-color: #bfdbfe; color: #1d4ed8; }
    .card-mis { background: #fef2f2; border-color: #fecaca; color: #b91c1c; }
    .card-none { background: #f8fafc; border-color: #e2e8f0; color: #94a3b8; }
    
    .role-icon { position: absolute; top: 3px; right: 3px; font-size: 0.75rem; }
    .hc-name { font-weight: 900; font-size: 0.7rem; width: 95%; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; line-height: 1.2; margin-top: 2px; }
    .hc-wp { font-size: 0.65rem; font-weight: bold; opacity: 0.85; margin-top: 2px; }

    .advice { font-size: 0.85rem; padding: 10px 15px; border-radius: 8px; line-height: 1.5; background: #fffbeb; border-left: 4px solid #f59e0b; color: #475569; font-weight: bold;}
    .adv-ok { background: #f0fdf4; border-color: #22c55e; color: #166534; }
    .adv-ng { background: #fef2f2; border-color: #ef4444; color: #991b1b; }

    /* === è£…å‚™ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ === */
    .gear-container { display: flex; flex-wrap: wrap; gap: 12px; }
    .g-card { flex: 1; min-width: 100%; background: #fff; padding: 15px 12px; border-radius: 12px; border: 1px solid #e2e8f0; box-shadow: 0 4px 10px rgba(0,0,0,0.03); box-sizing: border-box; }
    @media (min-width: 700px) { .g-card { min-width: 48%; } }
    .g-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; }
    .g-label { font-weight: bold; font-size: 0.85rem; color: #475569; display: flex; align-items: center; gap: 4px; min-width: 45px; }
    .g-input-group { display: flex; gap: 6px; justify-content: flex-end; flex: 1; min-width: 0; }
    
    .stepper-lv { width: 100px; } 
    .stepper-star { width: 130px; } 
    .stepper-star input { font-size: 13px; letter-spacing: -2px; padding-left: 2px; }

    .buff-info { font-size: 0.75rem; color: #d97706; background: #fffbeb; padding: 8px; border-radius: 6px; margin-top: 12px; text-align: center; border: 1px dashed #fbbf24; display: none; font-weight: bold;}
    .buff-info.active { display: block; animation: fadeIn 0.3s; }
    .cost-panel { margin-top: 15px; background: #fff; padding: 15px; border-radius: 10px; border-top: 4px solid #f59e0b; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
    .cost-row { display: flex; justify-content: space-between; font-size: 0.9rem; border-bottom: 1px dashed #e2e8f0; padding: 6px 0; font-weight: bold; color: #475569;}
    .cost-row:last-child { border-bottom: none; }

    .footer { position: fixed; bottom: 15px; left: 50%; transform: translateX(-50%); width: 92%; max-width: 500px; background: rgba(255,255,255,0.95); backdrop-filter: blur(10px); padding: 10px 15px; border-radius: 50px; border: 1px solid #fecaca; text-align: center; box-shadow: 0 8px 25px rgba(0,0,0,0.15); z-index: 999; font-weight: 900; color: #b91c1c; display: flex; justify-content: space-between; align-items: center; }
    .ft-main { font-size: 1.1rem; }
    .ft-sub { font-size: 0.8rem; color: #4b5563; background: #f8fafc; padding: 4px 10px; border-radius: 12px; border: 1px solid #e2e8f0; }
    
    .link-area { text-align: center; font-size: 0.85rem; margin-top: 25px; padding: 15px; border-top: 2px dashed #cbd5e1; color: #64748b; }
    .link-btn { display: inline-block; background: #fff; border: 1px solid #cbd5e1; padding: 8px 15px; border-radius: 20px; color: #2563eb; text-decoration: none; font-weight: bold; margin: 5px; box-shadow: 0 2px 4px rgba(0,0,0,0.03); transition: all 0.2s; }
    .link-btn:hover { background: #eff6ff; border-color: #3b82f6; transform: translateY(-1px); box-shadow: 0 4px 6px rgba(0,0,0,0.05);}
</style>
</head>
<body>

<div class="container">
    <h1>è‚²æˆã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ <span style="font-size:0.7rem; color:#94a3b8; font-weight:normal;">v16.00 </span></h1>

    <div class="tabs">
        <div class="tab-btn active" onclick="showTab('squad')">âš”ï¸ éƒ¨éšŠç·¨æˆ</div>
        <div class="tab-btn" onclick="showTab('gear')">ğŸ›¡ï¸ è£…å‚™ã‚·ãƒŸãƒ¥</div>
    </div>

    <div id="tab-squad" class="tab-content active">
        <div class="panel ai-panel">
            <div class="ai-title">
                <div><span>ğŸ¤– ç·¨æˆææ¡ˆ & å…¥æ›¿å€™è£œ</span></div>
                <button class="reset-btn" onclick="generateAiSuggestion()">å†åˆ†æ</button>
            </div>
            <div id="ai-result" class="suggestion-box" style="display:none;"></div>
            <div id="ai-placeholder" style="font-size:0.85rem; color:#64748b; padding:10px; text-align:center; font-weight:bold;">
                å„éƒ¨éšŠã®æ­¦è£…Lvã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚<br>å…¨ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰æœ€é©ãªçµ„ã¿åˆã‚ã›ã‚’åˆ†æã—ã¾ã™ã€‚
            </div>
        </div>

        <div class="panel route-panel">
            <div class="route-title">
                <div><span>ğŸ¯ æ¬¡ã®æ­¦è£…è‚²æˆã‚¿ãƒ¼ã‚²ãƒƒãƒˆ</span></div>
            </div>
            <div id="route-result" class="suggestion-box" style="display:none;"></div>
            <div id="route-placeholder" style="font-size:0.85rem; color:#64748b; padding:10px; text-align:center; font-weight:bold;">
                ã‚­ãƒ£ãƒ©ã‚’é…ç½®ã—ã¦æ­¦è£…Lvã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚
            </div>
        </div>

        <div class="panel" style="background:transparent; padding:0; border:none; box-shadow:none;">
            <div style="display:flex; justify-content:flex-end; margin-bottom:8px;">
                <button class="reset-btn" onclick="resetSquads()" style="background:#fff; border-color:#cbd5e1; padding:8px 12px;">ğŸ—‘ï¸ å…¨ç·¨æˆãƒªã‚»ãƒƒãƒˆ</button>
            </div>
            <div id="squad-container"></div>
        </div>
    </div>

    <div id="tab-gear" class="tab-content">
        <div class="gear-container">
            <div class="g-card">
                <div class="panel-header" style="color:#64748b; border-color:#e2e8f0;">ç¾åœ¨ã®è£…å‚™</div>
                <div class="g-row" style="margin-bottom:15px;">
                    <span class="g-label">âš”ï¸ æ­¦è£…Lv</span>
                    <div class="stepper" style="width:100px;"><button onclick="gearStep('cWeapon', -1)">-</button><input id="cWeapon" value="20" readonly><button onclick="gearStep('cWeapon', 1)">+</button></div>
                </div>
                <div id="current-gear-rows"></div>
                <div id="detail-curr" class="buff-info"></div>
            </div>

            <div class="g-card">
                <div class="panel-header" style="color:#b91c1c; border-color:#fecaca;">
                    ç›®æ¨™ã®è£…å‚™ <button class="reset-btn" onclick="resetGear()">ã‚¯ãƒªã‚¢</button>
                </div>
                <div class="g-row" style="margin-bottom:15px;">
                    <span class="g-label" style="color:#b91c1c;">âš”ï¸ ç›®æ¨™Lv</span>
                    <div class="stepper" style="border-color:#fecaca; width:100px;"><button onclick="gearStep('tWeapon', -1)">-</button><input id="tWeapon" value="20" readonly><button onclick="gearStep('tWeapon', 1)">+</button></div>
                </div>
                <div id="target-gear-rows"></div>
                <div id="detail-tgt" class="buff-info"></div>
            </div>
        </div>
        
        <div class="cost-panel">
            <div style="font-weight:900; color:#d97706; font-size:0.95rem; margin-bottom:8px;">ğŸ†™ ä¸è¶³ã—ã¦ã„ã‚‹è£…å‚™ãƒ¬ã‚·ãƒ”</div>
            <div id="cost-list" style="margin-bottom:12px;"></div>
            <div style="font-size:0.75rem; color:#64748b; background:#f8fafc; padding:8px; border-radius:6px; text-align:center; font-weight:bold;">
                â˜…0â†’1:5 / â˜…1â†’2:10 / â˜…2â†’3:15 / â˜…3â†’4:20 / â˜…4â†’5:èµ¤10
            </div>
        </div>
    </div>

    <div class="link-area">
        <div style="margin-bottom: 10px; font-weight: 900; color:#475569;">ğŸ’¡ æƒ…å ±åé›†ãƒ»å‚è€ƒã‚µã‚¤ãƒˆ</div>
        <a href="https://game8.jp/lastwar-survival" target="_blank" class="link-btn">ğŸ“˜ Game8 æ”»ç•¥Wiki</a>
        <a href="https://cpt-hedge.com/" target="_blank" class="link-btn">ğŸ‡ºğŸ‡¸ CPT HEDGE (æµ·å¤–ãƒ‡ãƒ¼ã‚¿)</a>
        <a href="https://alliance-duel.pages.dev/" target="_blank" class="link-btn">ğŸ› ï¸ é€£ç›Ÿå¯¾æ±ºãƒ„ãƒ¼ãƒ« (è‡ªä½œ)</a>
    </div>

</div>

<div id="footer-bar" class="footer" style="display:none;">
    <div class="ft-main">ä»Šã‚ˆã‚Š <span id="growth-rate" style="font-size:1.4rem;">1.00</span> å€!</div>
    <div class="ft-sub">å¿…è¦: <span style="color:#f59e0b;">UR<span id="ft-ur">0</span></span> <span style="color:#b91c1c;">MR<span id="ft-mr">0</span></span></div>
</div>

<script>
// --- State ---
window.currentBestSwap = null; 

// --- Config ---
const HEROES = {
    empty: {n:"- æœªè¨­å®š -", t:"none", r:"none", ur:false},
    murphy: {n:"ãƒãƒ¼ãƒ•ã‚£", t:"tank", r:"wall", ur:false},
    williams: {n:"ã‚¦ã‚£ãƒªã‚¢ãƒ ã‚º", t:"tank", r:"wall", ur:false},
    scarlett: {n:"ã‚¹ã‚«ãƒ¼ãƒ¬ãƒƒãƒˆ", t:"tank", r:"wall", ur:true},
    violet: {n:"ãƒ´ã‚£ã‚ªãƒ©", t:"tank", r:"wall", ur:true},
    kimberly: {n:"ã‚­ãƒ³ãƒãƒªãƒ¼", t:"tank", r:"atk", ur:false},
    stetmann: {n:"ã‚¹ãƒ†ãƒƒãƒ‰ãƒãƒ³", t:"tank", r:"atk", ur:false},
    mason: {n:"ãƒ¡ã‚¤ã‚½ãƒ³", t:"tank", r:"atk", ur:true},
    marshall: {n:"ãƒãƒ¼ã‚·ãƒ£ãƒ«", t:"tank", r:"sup", ur:false},
    lucius: {n:"ãƒ«ã‚·ã‚¦ã‚¹", t:"air", r:"wall", ur:false},
    carlie: {n:"ã‚«ãƒ¼ãƒªãƒ¼", t:"air", r:"wall", ur:false},
    dva: {n:"DVA", t:"air", r:"atk", ur:false},
    schuyler: {n:"ã‚¹ã‚«ã‚¤ãƒ©ãƒ¼", t:"air", r:"atk", ur:false},
    morrison: {n:"ãƒ¢ãƒªã‚½ãƒ³", t:"air", r:"atk", ur:false},
    sarah: {n:"ã‚µãƒ©", t:"air", r:"atk", ur:true},
    mcgregor: {n:"ãƒã‚¯ãƒ¬ã‚¬ãƒ¼", t:"mis", r:"wall", ur:false},
    adam: {n:"ã‚¢ãƒ€ãƒ ", t:"mis", r:"wall", ur:false},
    tesla: {n:"ãƒ†ã‚¹ãƒ©", t:"mis", r:"atk", ur:false},
    fiona: {n:"ãƒ•ã‚£ã‚ªãƒŠ", t:"mis", r:"atk", ur:false},
    swift: {n:"ã‚¹ã‚¦ã‚£ãƒ•ãƒˆ", t:"mis", r:"atk", ur:false},
    venom: {n:"ãƒ™ãƒãƒ ", t:"mis", r:"atk", ur:true}
};

const GEAR_TYPES = ['Gun', 'Data', 'Armor', 'Radar'];
const GEAR_NAMES = { 'Gun':'ğŸ”«ãƒ¬ãƒ¼ãƒ«ã‚¬ãƒ³', 'Data':'ğŸ’¾ãƒãƒƒãƒ—', 'Armor':'ğŸ›¡ï¸è£…ç”²', 'Radar':'ğŸ“¡ãƒ¬ãƒ¼ãƒ€ãƒ¼' };

const getMaxP = (s) => s === 4 ? 10 : 5;
const getSquadName = (s) => s === 4 ? "æ§ãˆå®¤" : `ç¬¬${s}éƒ¨éšŠ`;

// --- Initialization ---
window.onload = function() {
    initSquadHTML();
    initGearHTML();
    loadAllData();
    calculateGear();
};

function showTab(id) {
    document.querySelectorAll('.tab-content, .tab-btn').forEach(e => e.classList.remove('active'));
    document.getElementById('tab-'+id).classList.add('active');
    event.currentTarget.classList.add('active');
    document.getElementById('footer-bar').style.display = (id === 'gear') ? 'flex' : 'none';
}

function initSquadHTML() {
    let html = '';
    for(let s=1; s<=4; s++) {
        let isBench = s === 4;
        let openClass = s === 1 ? 'open' : '';
        let arrow = s === 1 ? 'â–¼' : 'â–¶';
        let title = isBench ? 'æ§ãˆå®¤ï¼ˆæœªç·¨æˆã‚­ãƒ£ãƒ©ï¼‰' : `ç¬¬${s}éƒ¨éšŠ`;
        
        html += `
        <div class="squad-section">
            <div class="squad-header" onclick="toggleSquad(${s}, this)">
                <span id="sq-title-${s}" style="flex:1; line-height:1.3;">${title}</span>
                <span style="margin-left:10px; color:#94a3b8;">${arrow}</span>
            </div>
            <div class="squad-body ${openClass}" id="sq-body-${s}">`;
            
        if(isBench) {
            html += `<div style="font-size:0.75rem; color:#64748b; margin-bottom:12px; font-weight:bold;">éƒ¨éšŠã«å…¥ã£ã¦ã„ãªã„ãŒè‚²æˆæ¸ˆã¿ã®ã‚­ãƒ£ãƒ©ã‚’ç™»éŒ²ã—ã¦ãŠãã¨ã€AIãŒå…¨ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’è¨ˆç®—ã—æœ€é©ãªå…¥æ›¿å€™è£œã‚’æç¤ºã—ã¾ã™ã€‚</div>`;
        } else {
            html += `<div id="adv-${s}" class="advice" style="display:none; margin-top:0; margin-bottom:12px;"></div>`;
        }

        let maxP = getMaxP(s);
        let slotsHtml = [];
        for(let p=1; p<=maxP; p++) {
            let isFront = p<=2;
            let slotClass = isBench ? "slot-bench" : (isFront ? "slot-front" : "slot-back");
            let badgeClass = isBench ? "badge-bench" : (isFront ? "badge-front" : "badge-back");
            let label = isBench ? "æ§ãˆ" : (isFront ? "å‰è¡›" : "å¾Œè¡›");
            
            slotsHtml.push(`
            <div class="hero-slot ${slotClass}">
                <div class="pos-badge ${badgeClass}">${label}</div>
                <select class="hero-select" id="h-${s}-${p}" onchange="updateSquad(${s})"></select>
                <div class="wp-wrap">
                    <span class="wp-label">Lv</span>
                    <div class="stepper" id="wp-box-${s}-${p}" style="width:105px;">
                        <button onclick="stepWp(${s},${p},-1)">-</button>
                        <input type="text" id="w-${s}-${p}" value="0" readonly>
                        <button onclick="stepWp(${s},${p},1)">+</button>
                    </div>
                </div>
            </div>`);
        }
        html += slotsHtml.join('');
        
        if(!isBench) {
            html += `<div class="visual-area"><span class="visual-label">é…ç½®ã‚¤ãƒ¡ãƒ¼ã‚¸</span><div id="vis-${s}" class="visual-grid"></div></div>`;
        }
        html += `</div></div>`;
    }
    document.getElementById('squad-container').innerHTML = html;
    
    let opts = '<option value="empty">- æœªè¨­å®š -</option>';
    let groups = { tank: '<optgroup label="ã€æˆ¦è»Šã€‘">', air: '<optgroup label="ã€èˆªç©ºæ©Ÿã€‘">', mis: '<optgroup label="ã€ãƒ­ã‚±ãƒ©ãƒ³ã€‘">' };
    
    for(let k in HEROES) {
        if(k === 'empty') continue;
        groups[HEROES[k].t] += `<option value="${k}">${HEROES[k].n}${HEROES[k].ur ? "(UR)" : ""}</option>`;
    }
    opts += groups.tank + '</optgroup>' + groups.air + '</optgroup>' + groups.mis + '</optgroup>';
    document.querySelectorAll('.hero-select').forEach(sel => sel.innerHTML = opts);
}

function toggleSquad(s, header) {
    let body = document.getElementById(`sq-body-${s}`);
    let arrow = header.children[1];
    body.classList.toggle('open');
    arrow.innerText = body.classList.contains('open') ? 'â–¼' : 'â–¶';
}

function stepWp(s, p, d) {
    let el = document.getElementById(`w-${s}-${p}`);
    let val = parseInt(el.value) || 0;
    el.value = Math.min(Math.max(val + d, 0), 30);
    updateSquad(s);
}

function updateSquad(s, skipAi = false) {
    lockDuplicateHeroes(s);
    let members = [];
    let counts = {tank:0, air:0, mis:0, none:0};
    
    for(let p=1; p<=getMaxP(s); p++) {
        let hid = document.getElementById(`h-${s}-${p}`).value;
        let wpEl = document.getElementById(`w-${s}-${p}`);
        let wpBox = document.getElementById(`wp-box-${s}-${p}`);
        let h = HEROES[hid];
        let currentVal = parseInt(wpEl.value) || 0;

        if(h.ur || hid === 'empty') {
            wpBox.classList.add('disabled');
            wpEl.value = h.ur ? "æœªå®Ÿè£…" : "-";
            currentVal = 0;
        } else {
            wpBox.classList.remove('disabled');
            wpEl.value = currentVal === 0 ? "æœªè§£æ”¾" : currentVal;
        }

        members.push({ ...h, id:hid, wp:currentVal, pos:p });
        counts[h.t]++;
    }

    if(s !== 4) {
        renderVisual(s, members);
        analyzeSquad(s, members, counts);
    }
    
    if(!skipAi) {
        saveData();
        generateAiSuggestion(); 
    }
}

function lockDuplicateHeroes(s) {
    let selected = Array.from(document.querySelectorAll(`#sq-body-${s} .hero-select`)).map(el => el.value).filter(v => v !== 'empty');
    for(let p=1; p<=getMaxP(s); p++) {
        let sel = document.getElementById(`h-${s}-${p}`);
        Array.from(sel.options).forEach(opt => {
            opt.disabled = opt.value !== 'empty' && selected.includes(opt.value) && opt.value !== sel.value;
            opt.style.color = opt.disabled ? "#cbd5e1" : "#1e293b";
        });
    }
}

function renderVisual(s, m) {
    let html = m.map(h => {
        if(h.id === 'empty') return `<div class="hero-card card-none"><span style="font-size:0.7rem;">æœªè¨­å®š</span></div>`;
        let cls = h.t === 'tank' ? 'card-tank' : h.t === 'air' ? 'card-air' : 'card-mis';
        let roleIcon = h.r === 'wall' ? 'ğŸ›¡ï¸' : h.r === 'atk' ? 'âš”ï¸' : 'ğŸ› ï¸';
        let urTag = h.ur ? '<span style="color:#8b5cf6;font-size:0.6rem;">(UR)</span>' : '';
        let wpTxt = h.ur ? 'æœªå®Ÿè£…' : (h.wp === 0 ? 'æœªè§£æ”¾' : `Lv${h.wp}`);
        
        let synName = "";
        if (h.wp >= 30) {
            if (h.id === 'williams') synName = "é‹¼é‰„ã®å¿ƒ";
            else if (h.id === 'kimberly') synName = "è‡´å‘½ã®èŠ±ç«";
            else if (h.id === 'dva') synName = "è¶…é€Ÿèµ·å‹•";
            else if (h.id === 'tesla') synName = "é›»ç£èª˜å°";
            else if (h.id === 'carlie') synName = "ãºãºã€ãŠã­ãŒã„ï¼";
            else if (h.id === 'schuyler') synName = "è¶…é«˜å‡ºåŠ›é›»ç£å¦¨å®³";
            else if (h.id === 'stetmann') synName = "é›»ç£ãƒãƒªã‚¢";
            else if (h.id === 'morrison') synName = "çˆ†è£‚å¾¹ç”²å¼¾";
            else synName = "å°‚ç”¨æ­¦è£…";
        }
        
        let synHtml = synName ? `<div style="font-size:0.55rem; color:#d97706; font-weight:900; margin-top:2px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; width:95%;">âœ¨${synName}</div>` : "";
        
        return `<div class="hero-card ${cls}"><div class="role-icon">${roleIcon}</div><div class="hc-name">${h.n}${urTag}</div><div class="hc-wp">${wpTxt}</div>${synHtml}</div>`;
    });
    
    document.getElementById(`vis-${s}`).innerHTML = `<div class="v-row-front">${html[0]}${html[1]}</div><div class="v-row-back">${html[2]}${html[3]}${html[4]}</div>`;
}

function analyzeSquad(s, m, c) {
    let div = document.getElementById(`adv-${s}`);
    let titleSpan = document.getElementById(`sq-title-${s}`);
    let baseTitle = `ç¬¬${s}éƒ¨éšŠ`;

    if(c.none > 0) { 
        div.style.display = 'none'; 
        if(s !== 4) titleSpan.innerHTML = baseTitle;
        return; 
    }

    let maxC = Math.max(c.tank, c.air, c.mis);
    let buff = maxC===5?"+20%": maxC===4?"+15%": maxC===3?"+10%":"0%";
    let mainT = Object.keys(c).reduce((a,b)=> c[a]>c[b]?a:b);
    
    titleSpan.innerHTML = `${baseTitle} <span style="font-size:0.7rem; font-weight:bold; color:#ea580c; display:inline-block; margin-left:6px; background:#fffbeb; padding:2px 6px; border-radius:10px; border:1px solid #fcd34d;">åŒç¨®${maxC}ä½“ (ãƒãƒ•${buff})</span>`;
    
    let msgs = [];
    let status = 'ok';

    if(['atk','sup'].includes(m[0].r) || ['atk','sup'].includes(m[1].r)) {
        msgs.push("âš ï¸ å‰è¡›ã«ç«åŠ›/æ”¯æ´ãŒã„ã¾ã™ã€‚ç›¾å½¹(ğŸ›¡ï¸)ã‚’æ¨å¥¨ã€‚"); status = 'ng';
    }

    if(maxC === 4) {
        let out = m.find(h => h.t !== mainT);
        if(out.id === 'lucius') {
            if(out.wp < 10) { msgs.push("âš ï¸ ãƒ«ã‚·ã‚¦ã‚¹å‡ºå¼µã¯ã€æ­¦è£…Lv10ã€‘ä»¥ä¸ŠãŒå¿…é ˆã§ã™ã€‚"); status='ng'; }
            else msgs.push("â­• ãƒ«ã‚·ã‚¦ã‚¹å‡ºå¼µOKï¼å›é¿æ€§èƒ½ãŒå„ªç§€ã§ã™ã€‚");
        } else if(out.id === 'murphy') {
            if(out.wp < 20) { msgs.push("âš ï¸ ãƒãƒ¼ãƒ•ã‚£ãƒ¼å‡ºå¼µã¯ã€æ­¦è£…Lv20ã€‘ä»¥ä¸Šæ¨å¥¨ã€‚"); status='ng'; }
            else msgs.push("â­• ãƒãƒ¼ãƒ•ã‚£ãƒ¼å‡ºå¼µOKï¼ç‰©ç†ç›¾ã¨ã—ã¦æ©Ÿèƒ½ã—ã¾ã™ã€‚");
        } else if(out.ur && out.r === 'wall') {
            msgs.push(`â­• ${out.n}(UR)å‡ºå¼µOKï¼é«˜HPã§å„ªç§€ãªå£ã«ãªã‚Šã¾ã™ã€‚`);
        } else if(out.r === 'atk') {
            if(out.ur) { msgs.push(`âš ï¸ ${out.n}ã®å‡ºå¼µã¯ç«åŠ›ä¸è¶³ã®ãŸã‚éæ¨å¥¨ã§ã™ã€‚`); status='ng'; }
            else if(out.wp < 30) { msgs.push(`âš ï¸ ã‚¢ã‚¿ãƒƒã‚«ãƒ¼å‡ºå¼µã¯ã€æ­¦è£…Lv30ã€‘ãŒå¿…è¦ã§ã™ã€‚`); status='ng'; }
            else msgs.push(`ğŸ”¥ ${out.n}å‡ºå¼µOKï¼Lv30ã®ç«åŠ›ã§ã‚´ãƒªæŠ¼ã—å¯èƒ½ã€‚`);
        } else {
            msgs.push(`âš ï¸ ${out.n}ã®å‡ºå¼µãƒ¡ãƒªãƒƒãƒˆã¯è–„ã„ã§ã™ã€‚`); status='ng';
        }
    } else if (maxC < 4) {
        msgs.push("âŒ ãƒãƒ•ãŒä½ã„ã§ã™ã€‚4ä½“ä»¥ä¸Šæƒãˆã¾ã—ã‚‡ã†ã€‚"); status='ng';
    }

    if(msgs.length > 0) {
        div.style.display = 'block';
        div.className = "advice " + (status==='ok'?'adv-ok':'adv-ng');
        div.innerHTML = msgs.join('<br>');
    } else {
        div.style.display = 'none';
    }
}

// --- AI Logic ---
function calcSquadScore(squadArr) {
    let score = 0;
    let counts = {tank:0, air:0, mis:0};
    let activeSynergies = [];

    squadArr.forEach(c => { score += c.pts; counts[c.t]++; });

    let maxC = Math.max(counts.tank, counts.air, counts.mis);
    score += maxC === 5 ? 80 : maxC === 4 ? 40 : maxC === 3 ? 15 : 0;

    if (squadArr.some(c => c.id === 'murphy' && c.pos <= 2)) {
        score += 50; activeSynergies.push("ãƒãƒ¼ãƒ•ã‚£ãƒ¼å‰åˆ—é…ç½®");
    }
    if (squadArr.some(c => c.id === 'marshall')) {
        score += 30; activeSynergies.push("ãƒãƒ¼ã‚·ãƒ£ãƒ«ã®å…¨ä½“ãƒãƒ•");
    }

    return { score, maxC, synergies: activeSynergies };
}

function applySwap() {
    if(!window.currentBestSwap) return;
    
    document.querySelectorAll('.hero-select option').forEach(opt => opt.disabled = false);

    window.currentBestSwap.in.forEach((cIn, i) => {
        let cOut = window.currentBestSwap.out[i];
        let inSel = document.getElementById(`h-${cIn.squad}-${cIn.pos}`);
        let inWp = document.getElementById(`w-${cIn.squad}-${cIn.pos}`);
        let outSel = document.getElementById(`h-${cOut.squad}-${cOut.pos}`);
        let outWp = document.getElementById(`w-${cOut.squad}-${cOut.pos}`);
        
        [inSel.value, outSel.value] = [outSel.value, inSel.value];
        [inWp.value, outWp.value] = [outWp.value, inWp.value];
    });
    
    for(let s=1; s<=4; s++) updateSquad(s, true); 
    saveData();
    generateAiSuggestion(); 
}

function generateAiSuggestion() {
    window.currentBestSwap = null; 
    let resultBox = document.getElementById('ai-result');
    let placeH = document.getElementById('ai-placeholder');
    let routeResult = document.getElementById('route-result');
    let routePlace = document.getElementById('route-placeholder');
    
    let allScores = { tank: 0, air: 0, mis: 0 }, squadScores = {1:0, 2:0, 3:0, 4:0};
    let roster = [], mainSquad = [];

    const getEvalMark = (wp) => wp >= 30 ? "ğŸ‘‘" : wp >= 20 ? "â—" : wp >= 10 ? "ã€‡" : "Ã—"; 

    for(let s=1; s<=4; s++) {
        for(let p=1; p<=getMaxP(s); p++) {
            let hid = document.getElementById(`h-${s}-${p}`).value;
            if(hid === 'empty') continue;

            let h = HEROES[hid];
            let wp = parseInt(document.getElementById(`w-${s}-${p}`).value) || 0;
            let points = (h.ur ? 15 : 10) + (wp * 5); 
            let charSyns = []; 

            if (wp >= 10) points += 5;
            if (wp >= 20) points += 15;
            
            if (wp >= 30) {
                points += 20; 
                if (hid === 'williams') { points += 40; charSyns.push("é‹¼é‰„ã®å¿ƒ"); } 
                else if (hid === 'kimberly') { points += 35; charSyns.push("è‡´å‘½ã®èŠ±ç«"); } 
                else if (hid === 'dva') { points += 35; charSyns.push("è¶…é€Ÿèµ·å‹•"); } 
                else if (hid === 'tesla') { points += 35; charSyns.push("é›»ç£èª˜å°"); } 
                else if (hid === 'carlie') { points += 35; charSyns.push("ãºãºã€ãŠã­ãŒã„ï¼"); } 
                else if (hid === 'schuyler') { points += 35; charSyns.push("è¶…é«˜å‡ºåŠ›é›»ç£å¦¨å®³"); } 
                else if (hid === 'stetmann') { points += 30; charSyns.push("é›»ç£ãƒãƒªã‚¢"); } 
                else if (hid === 'morrison') { points += 25; charSyns.push("çˆ†è£‚å¾¹ç”²å¼¾"); }
                else { points += 25; charSyns.push("å°‚ç”¨æ­¦è£…"); }
            }

            allScores[h.t] += points; squadScores[s] += points;
            let charData = { ...h, id: hid, squad: s, pos: p, wp: wp, pts: points, charSyns: charSyns };
            roster.push(charData);
            if(s === 1) mainSquad.push(charData); 
        }
    }

    // --- è‚²æˆãƒ«ãƒ¼ãƒˆï¼†å…µç¨®ç§»è¡Œã‚¢ãƒ‰ãƒã‚¤ã‚¹ ãƒ­ã‚¸ãƒƒã‚¯ ---
    if(roster.length === 0) {
        routeResult.style.display = 'none'; routePlace.style.display = 'block';
    } else {
        routePlace.style.display = 'none'; routeResult.style.display = 'block';
        
        const getWp = (id) => roster.find(h => h.id === id)?.wp || 0;
        // èˆªç©ºæ©Ÿ
        const dva = getWp('dva'), mor = getWp('morrison'), sky = getWp('schuyler'), luc = getWp('lucius'), car = getWp('carlie');
        const airTotal = dva + mor + sky + luc + car;
        // æˆ¦è»Š
        const mur = getWp('murphy'), kim = getWp('kimberly'), stet = getWp('stetmann'), wil = getWp('williams');
        const tankTotal = kim + mur + stet + wil;
        // ãƒŸã‚µã‚¤ãƒ«
        const tesla = getWp('tesla'), fiona = getWp('fiona'), swift = getWp('swift'), adam = getWp('adam'), mcg = getWp('mcgregor');
        const misTotal = tesla + fiona + swift + adam + mcg;

        // 3ã™ãã¿ã®ãƒ¡ã‚¤ãƒ³è»¸åˆ¤å®š
        let mainAxis = 'tank';
        if (tesla >= 20 || (misTotal > airTotal && misTotal > tankTotal)) {
            mainAxis = 'mis';
        } else if (airTotal >= tankTotal || (dva >= kim && dva > 0)) {
            mainAxis = 'air';
        }
        
        let targetHtml = "";
        let axisBadge = "";

        // 1. æ¬¡ã®è‚²æˆã‚¿ãƒ¼ã‚²ãƒƒãƒˆåˆ¤å®š
        if (mainAxis === 'mis') {
            axisBadge = "<div class='route-badge-tank' style='background:#fef2f2; color:#b91c1c; border-color:#fecaca;'>ğŸš€ ç¾åœ¨ã®ãƒ¡ã‚¤ãƒ³ï¼šãƒŸã‚µã‚¤ãƒ«ç·¨æˆ</div>";
            if (tesla < 30) targetHtml = "ğŸ”¥ <span class='route-highlight' style='color:#b91c1c;'>ãƒ†ã‚¹ãƒ©ã‚’Lv.30ã¸</span><br>æœ€å¼·ã®çŸ›ï¼ã¾ãšã¯ãƒ†ã‚¹ãƒ©ã®ç«åŠ›ã‚’æœ€å¤§åŒ–ã—ã¦ãã ã•ã„ã€‚";
            else if (fiona < 20) targetHtml = "ğŸ’¥ <span class='route-highlight' style='color:#b91c1c;'>ãƒ•ã‚£ã‚ªãƒŠã‚’Lv.20ã¸</span><br>åœ§å€’çš„ãªã‚¹ã‚­ãƒ«å€ç‡ã‚’æ´»ã‹ã™ãŸã‚ã®ã‚µãƒ–ã‚¢ã‚¿ãƒƒã‚«ãƒ¼å¼·åŒ–ã§ã™ã€‚";
            else if (mcg < 20) targetHtml = "ğŸ›¡ï¸ <span class='route-highlight' style='color:#b91c1c;'>ãƒã‚¯ãƒ¬ã‚¬ãƒ¼ã‚’Lv.20ã¸</span><br>å‰åˆ—ã®è€ä¹…ã‚’å®‰å®šã•ã›ã¾ã™ã€‚";
            else targetHtml = "âœ¨ <span class='route-highlight' style='color:#b91c1c;'>åŸºç›¤å®Œæˆï¼ç›®çš„ã«åˆã‚ã›ã¦é¸æŠ</span><br><b style='color:#ea580c;'>æ”»æ’ƒç‰¹åŒ–</b>ï¼šã‚¹ã‚¦ã‚£ãƒ•ãƒˆ (ç«åŠ›ã‚¢ãƒƒãƒ—)<br><b style='color:#3b82f6;'>é˜²å¾¡å®‰å®š</b>ï¼šã‚¢ãƒ€ãƒ  (è€ä¹…ã‚¢ãƒƒãƒ—)";
        } else if (mainAxis === 'air') {
            axisBadge = "<div class='route-badge-air'>âœˆï¸ ç¾åœ¨ã®ãƒ¡ã‚¤ãƒ³ï¼šèˆªç©ºæ©Ÿç·¨æˆ</div>";
            if (dva < 30) targetHtml = "ğŸ”¥ <span class='route-highlight'>DVAã‚’Lv.30ã¸</span><br>ç¾åœ¨æœ€å„ªå…ˆï¼è¿½åŠ åŠ¹æœè§£æ”¾ã¾ã§ä¸‡èƒ½æ¬ ç‰‡ã‚’å…¨é›†ä¸­ã•ã›ã¦ãã ã•ã„ã€‚";
            else if (mur < 20) targetHtml = "ğŸ›¡ï¸ <span class='route-highlight'>ãƒãƒ¼ãƒ•ã‚£ãƒ¼ã‚’Lv.20ã¸</span><br>DVAå®Œæˆå¾Œã®å‡ºå¼µãƒ‘ãƒ¼ãƒ„ã¨ã—ã¦è‚²æˆã€‚ãƒ­ã‚±ãƒ©ãƒ³å¯¾ç­–ã«å¿…é ˆã§ã™ã€‚";
            else if (sky < 20) targetHtml = "âš¡ <span class='route-highlight'>ã‚¹ã‚«ã‚¤ãƒ©ãƒ¼ã‚’Lv.20ã¸</span><br>ã‚¹ã‚¿ãƒ³ã®å›è»¢ç‡ã‚’ä¸Šã’ã€ç›¸æ‰‹ã®ã‚¨ãƒ¼ã‚¹ã‚’å°ã˜ã¾ã™ã€‚";
            else if (luc < 20) targetHtml = "ğŸ° <span class='route-highlight'>ãƒ«ã‚·ã‚¦ã‚¹ã‚’Lv.20ã¸</span><br>èˆªç©ºãƒŸãƒ©ãƒ¼æˆ¦ã§ç«¶ã‚Šå‹ã¤ãŸã‚ã«å‰åˆ—ã®è€ä¹…ã‚’å¼·åŒ–ã—ã¾ã™ã€‚";
            else targetHtml = "âœ¨ <span class='route-highlight'>åŸºç›¤å®Œæˆï¼ç›®çš„ã«åˆã‚ã›ã¦é¸æŠ</span><br><b style='color:#ea580c;'>æ”»æ’ƒç‰¹åŒ–</b>ï¼šãƒ¢ãƒªã‚½ãƒ³ (ç«åŠ›ã‚¢ãƒƒãƒ—)<br><b style='color:#3b82f6;'>é˜²å¾¡å®‰å®š</b>ï¼šã‚«ãƒ¼ãƒªãƒ¼ (å›é¿ã‚¢ãƒƒãƒ—)";
        } else {
            axisBadge = "<div class='route-badge-tank'>ğŸšœ ç¾åœ¨ã®ãƒ¡ã‚¤ãƒ³ï¼šæˆ¦è»Šç·¨æˆ</div>";
            if (kim < 30) targetHtml = "ğŸ”¥ <span class='route-highlight'>ã‚­ãƒ³ãƒãƒªãƒ¼ã‚’Lv.30ã¸</span><br>ãƒ¡ã‚¤ãƒ³ç«åŠ›ã¨ã—ã¦æœ€å„ªå…ˆã§ã™ã€‚";
            else if (mur < 20) targetHtml = "ğŸ›¡ï¸ <span class='route-highlight'>ãƒãƒ¼ãƒ•ã‚£ãƒ¼ã‚’Lv.20ã¸</span><br>å‰åˆ—ã®è€ä¹…ã‚’ç¢ºä¿ã—ã¾ã™ã€‚";
            else targetHtml = "âœ¨ <span class='route-highlight'>åŸºç›¤å®Œæˆï¼ç›®çš„ã«åˆã‚ã›ã¦é¸æŠ</span><br><b style='color:#ea580c;'>æ”»æ’ƒç‰¹åŒ–</b>ï¼šã‚¹ãƒ†ãƒƒãƒ‰ãƒãƒ³ (ç«åŠ›ã‚¢ãƒƒãƒ—)<br><b style='color:#3b82f6;'>é˜²å¾¡å®‰å®š</b>ï¼šã‚¦ã‚£ãƒªã‚¢ãƒ ã‚º (è€ä¹…ã‚¢ãƒƒãƒ—)";
        }

        // 2. å…µç¨®ç§»è¡Œã‚¢ãƒ‰ãƒã‚¤ã‚¹åˆ¤å®š
        let transitionHtml = "";
        if (mainAxis === 'mis') {
            transitionHtml = "ğŸš€ <b>ã‚¨ãƒ³ãƒ‰ã‚³ãƒ³ãƒ†ãƒ³ãƒ„åˆ°é”ï¼š</b><br>ç¾ç’°å¢ƒã®é ‚ç‚¹ã€ãƒŸã‚µã‚¤ãƒ«éƒ¨éšŠã¸ã®ç§»è¡ŒãŒé€²ã‚“ã§ã„ã¾ã™ï¼èˆªç©ºæ©Ÿãƒ¡ã‚¿ã‚’å®Œå…¨ã«ç ´å£Šã§ãã‚‹ã®ã§ã€ã“ã®ã¾ã¾è‚²æˆã‚’æ¥µã‚ã¾ã—ã‚‡ã†ã€‚";
        } else if (mainAxis === 'air') {
            if (dva >= 30 && luc >= 20 && sky >= 20) {
                transitionHtml = "ğŸ”„ <b>æœ€çµ‚ãƒ¡ã‚¿ã¸ã®æº–å‚™ï¼š</b><br>èˆªç©ºæ©ŸãŒæ¥µã¾ã£ã¦ãã¾ã—ãŸï¼ã‚µãƒ¼ãƒãƒ¼å†…ã«èˆªç©ºæ©ŸãŒå¢—ãˆã¦ããŸã‚‰ã€æœ€å¼·ã®ã‚¢ãƒ³ãƒã§ã‚ã‚‹<b>ãƒŸã‚µã‚¤ãƒ«ï¼ˆãƒ†ã‚¹ãƒ©è»¸ï¼‰</b>ã®è‚²æˆã‚’è£ã§é€²ã‚ã‚‹ã®ãŒã‚¬ãƒå‹¢ã®æœ€çµ‚åˆ°é”ç‚¹ã§ã™ã€‚";
            } else {
                transitionHtml = "âœˆï¸ <b>èˆªç©ºæ©Ÿã‚·ãƒ•ãƒˆé€²è¡Œä¸­ï¼š</b><br>å¯¾æˆ¦è»Šãƒ¡ã‚¿ã¸ã®ç§»è¡ŒãŒé †èª¿ã§ã™ã€‚ã¾ãšã¯DVAã‚’è»¸ã¨ã—ãŸã“ã®ç·¨æˆã‚’æ¥µã‚ã€ã‚¢ãƒªãƒ¼ãƒŠã§åœ§å€’çš„æœ‰åˆ©ã‚’å–ã‚Šã¾ã—ã‚‡ã†ï¼";
            }
        } else {
            if (kim >= 30 && mur >= 20) {
                transitionHtml = "ğŸ”„ <b>æ¬¡ä¸–ä»£ã¸ã®ç§»è¡Œæ¨å¥¨ï¼š</b><br>æˆ¦è»Šã®å¿…é ˆåŸºç›¤ãŒå®Œæˆã—ã¾ã—ãŸï¼ã•ã‚‰ã«ä¸Šã‚’ç›®æŒ‡ã™ãªã‚‰ã€ç‹é“ã®<b>èˆªç©ºæ©Ÿï¼ˆDVAï¼‰</b>ã¸ç§»è¡Œã™ã‚‹ã‹ã€èŒ¨ã®é“ã§ã™ãŒæœ€çµ‚æœ€å¼·ã®<b>ãƒŸã‚µã‚¤ãƒ«ï¼ˆãƒ†ã‚¹ãƒ©ï¼‰</b>ã‚’ç›®æŒ‡ã™ãƒ•ã‚§ãƒ¼ã‚ºã§ã™ã€‚";
            } else {
                transitionHtml = "ğŸšœ <b>æˆ¦è»ŠåŸºç›¤ã®æ§‹ç¯‰æœŸï¼š</b><br>å…µç¨®ç§»è¡Œã‚’è€ƒãˆã‚‹ã®ã¯ã¾ã æ—©ã„ã§ã™ã€‚ã¾ãšã¯å¯¾äººãƒ»PvEä¸¡æ–¹ã§è…ã‚‰ãªã„ã€ã‚­ãƒ³ãƒãƒªãƒ¼Lv30ï¼‹ãƒãƒ¼ãƒ•ã‚£ãƒ¼Lv20ã€ã®å®Œæˆã‚’ä¸€ç›´ç·šã«ç›®æŒ‡ã—ã¾ã—ã‚‡ã†ã€‚";
            }
        }
        
        routeResult.innerHTML = `${axisBadge}<div style="font-size:0.9rem; line-height:1.6; color:#334155;">${targetHtml}</div>
        <div style="margin-top:12px; padding-top:10px; border-top:1px dashed #cbd5e1; font-size:0.85rem; color:#475569; background:#f8fafc; padding:10px; border-radius:8px;">
            ${transitionHtml}
        </div>`;
    }

    // --- å…¥æ›¿ææ¡ˆãƒ­ã‚¸ãƒƒã‚¯ ---
    if(roster.length === 0 || mainSquad.length === 0) {
        resultBox.style.display = 'none'; placeH.style.display = 'block';
        return;
    }
    
    placeH.style.display = 'none'; resultBox.style.display = 'block';

    let bench = roster.filter(c => c.squad !== 1);
    let currentEval = calcSquadScore(mainSquad); 
    let bestSwap = null, bestScore = currentEval.score + 5; 

    // 1ä½“å…¥æ›¿
    bench.forEach(bChar => {
        mainSquad.forEach(mChar => {
            if((bChar.r === 'wall') === (mChar.r === 'wall')) {
                let testSquad = mainSquad.map(c => c.pos === mChar.pos ? {...bChar, pos: mChar.pos} : c);
                let testEval = calcSquadScore(testSquad);
                if(testEval.score > bestScore) { bestScore = testEval.score; bestSwap = { in: [bChar], out: [mChar], eval: testEval }; }
            }
        });
    });

    // 2ä½“å…¥æ›¿
    for(let i=0; i<bench.length; i++){
        for(let j=i+1; j<bench.length; j++){
            let b1 = bench[i], b2 = bench[j];
            if(b1.t !== b2.t) continue;
            for(let m1=0; m1<mainSquad.length; m1++){
                for(let m2=m1+1; m2<mainSquad.length; m2++){
                    let o1 = mainSquad[m1], o2 = mainSquad[m2];
                    let match1 = (b1.r==='wall' === o1.r==='wall') && (b2.r==='wall' === o2.r==='wall');
                    let match2 = (b1.r==='wall' === o2.r==='wall') && (b2.r==='wall' === o1.r==='wall');
                    if(match1 || match2) {
                        let testSquad = [...mainSquad];
                        testSquad[m1] = match1 ? {...b1, pos: o1.pos} : {...b2, pos: o1.pos};
                        testSquad[m2] = match1 ? {...b2, pos: o2.pos} : {...b1, pos: o2.pos};
                        let testEval = calcSquadScore(testSquad);
                        if(testEval.score > bestScore) { bestScore = testEval.score; bestSwap = { in: [b1, b2], out: [o1, o2], eval: testEval }; }
                    }
                }
            }
        }
    }

    if (bestSwap) window.currentBestSwap = bestSwap;

    const formatChar = (c, isOut) => {
        let wpTxt = (c.ur && c.wp === 0) ? "æœªå®Ÿè£…" : `Lv${c.wp}`;
        let sub = isOut ? "ç¾åœ¨" : getSquadName(c.squad).replace('éƒ¨éšŠ', ''); 
        let color = isOut ? "#b91c1c" : "#15803d";
        let synBadge = (!isOut && c.charSyns.length > 0) ? `<div style="font-size:0.65rem; color:#d97706; background:#fef3c7; padding:2px 6px; border-radius:10px; margin-top:6px; display:inline-block; font-weight:bold; border:1px solid #fde68a;">âœ¨ ${c.charSyns[c.charSyns.length-1]}</div>` : "";
        
        return `<div style="margin-top:4px;"><div style="font-size:1.05rem; font-weight:900; color:${color}; line-height:1.2;">${c.n}</div><div style="font-size:0.75rem; color:#475569; margin-top:4px; line-height:1.3;">${sub}: ${wpTxt} / ${getEvalMark(c.wp)}</div>${synBadge}</div>`;
    };

    let adviceType = "", suggestionText = "", swapCandidateHtml = "";
    const getBuffText = (count) => count === 5 ? "20%" : count === 4 ? "15%" : count === 3 ? "10%" : "0%";

    if (!bestSwap) {
        adviceType = "âœ¨ ç¾åœ¨ã®ç·¨æˆãŒãƒ™ã‚¹ãƒˆã§ã™";
        suggestionText = `ç¾çŠ¶ã®ç¬¬1éƒ¨éšŠãŒæœ€ã‚‚é«˜ã„ãƒãƒ†ãƒ³ã‚·ãƒ£ãƒ«ã‚’ç™ºæ®ã§ãã¾ã™ã€‚`;
        swapCandidateHtml = `<div class="swap-candidate" style="text-align:center; padding:15px;"><span class="swap-title" style="border:none; margin-bottom:5px;">${adviceType}</span><div style="font-size:0.85rem;">${suggestionText}</div></div>`;
    } else {
        let oMax = currentEval.maxC, nMax = bestSwap.eval.maxC, merit = "";
        let awakenedSkills = bestSwap.in.map(c => c.charSyns).flat();
        let synText = awakenedSkills.length > 0 ? `<br><span style="color:#d97706; font-size:0.8rem; display:inline-block; margin-top:4px;">ğŸ’¡ <b>è¦šé†’åŠ¹æœï¼ˆ${awakenedSkills[awakenedSkills.length-1]}ç­‰ï¼‰ã§ã•ã‚‰ã«æœ‰åˆ©ã«ï¼</b></span>` : "";

        if (nMax < oMax) {
            let syns = [];
            if(bestSwap.eval.synergies.includes('ãƒãƒ¼ãƒ•ã‚£ãƒ¼å‰åˆ—é…ç½®') && !currentEval.synergies.includes('ãƒãƒ¼ãƒ•ã‚£ãƒ¼å‰åˆ—é…ç½®')) syns.push("ãƒãƒ¼ãƒ•ã‚£ãƒ¼ã®ç›¾");
            if(bestSwap.eval.synergies.includes('ãƒãƒ¼ã‚·ãƒ£ãƒ«ã®å…¨ä½“ãƒãƒ•') && !currentEval.synergies.includes('ãƒãƒ¼ã‚·ãƒ£ãƒ«ã®å…¨ä½“ãƒãƒ•')) syns.push("ãƒãƒ¼ã‚·ãƒ£ãƒ«ã®ãƒãƒ•");
            
            merit = syns.length > 0 
                ? `é™£å½¢ãƒãƒ•ã®ä½ä¸‹ï¼ˆ${getBuffText(oMax)}â¡${getBuffText(nMax)}ï¼‰ã‚’<b>ã€${syns.join('ã¨')}ã€‘</b>ã§å®Œå…¨ã«ã‚«ãƒãƒ¼ã—ã€ç·åˆåŠ›ãŒUPã—ã¾ã™ï¼${synText}` 
                : `é™£å½¢ãƒãƒ•ã®ä½ä¸‹ï¼ˆ${getBuffText(oMax)}â¡${getBuffText(nMax)}ï¼‰ã‚’ã€é«˜Lvæ­¦è£…ã®åœ§å€’çš„ãªã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å·®ã§å®Œå…¨ã«ã‚«ãƒãƒ¼ã—ã¾ã™ï¼${synText}`;
            adviceType = bestSwap.in.length === 2 && nMax === 3 ? "ğŸ›©ï¸ ãƒ¡ã‚¿ç§»è¡Œãƒ«ãƒ¼ãƒˆ (3+2)" : "ğŸ’¡ å¼·åŠ›ãªç•°ç¨®å‡ºå¼µ";
        } else if (nMax > oMax) {
            adviceType = "âœ¨ ç†æƒ³é™£å½¢ã¸ã®ç§»è¡Œ";
            merit = `åŒå…µç¨®ãƒœãƒ¼ãƒŠã‚¹ï¼ˆ${getBuffText(nMax)}ï¼‰ãŒæ–°ãŸã«ç™ºå‹•ã—ã€éƒ¨éšŠå…¨ä½“ã®åŸºç¤ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãŒå¤§ããè·³ã­ä¸ŠãŒã‚Šã¾ã™ï¼${synText}`;
        } else {
            adviceType = "ğŸš€ ä¸Šä½äº’æ›ã¸ã®å…¥ã‚Œæ›¿ãˆ";
            merit = `é™£å½¢ãƒãƒ•ã‚’ç¶­æŒã—ãŸã¾ã¾ã€ã‚­ãƒ£ãƒ©å˜ä½“ã®ãƒãƒ†ãƒ³ã‚·ãƒ£ãƒ«ã‚’å¤§å¹…ã«ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã§ãã¾ã™ï¼${synText}`;
        }

        suggestionText = `ä»¥ä¸‹ã®å…¥ã‚Œæ›¿ãˆã§ç·åˆã‚¹ã‚³ã‚¢ãŒã‚¢ãƒƒãƒ—ã—ã¾ã™ã€‚`;
        
        swapCandidateHtml = `
        <div class="swap-candidate">
            <span class="swap-title" style="margin-bottom:8px;">${adviceType}</span>
            <div style="font-size:0.85rem; margin-bottom:10px;">${suggestionText}</div>
            <div style="display:flex; justify-content:center; align-items:stretch; gap:10px; margin:12px 0;">
                <div style="flex:1; min-width:0; background:#f0fdf4; border:2px solid #bbf7d0; border-radius:10px; padding:10px 4px; text-align:center; box-sizing:border-box;">
                    <div style="font-size:0.8rem; color:#166534; font-weight:900; margin-bottom:6px;">ğŸŸ¢ IN</div>
                    ${bestSwap.in.map(c => formatChar(c, false)).join('')}
                </div>
                <div style="display:flex; align-items:center; justify-content:center; font-size:1.4rem; color:#cbd5e1;">ğŸ”„</div>
                <div style="flex:1; min-width:0; background:#fef2f2; border:2px solid #fecaca; border-radius:10px; padding:10px 4px; text-align:center; box-sizing:border-box;">
                    <div style="font-size:0.8rem; color:#991b1b; font-weight:900; margin-bottom:6px;">ğŸ”´ OUT</div>
                    ${bestSwap.out.map(c => formatChar(c, true)).join('')}
                </div>
            </div>
            <div style="margin-top:10px; font-size:0.85rem; background:#fff; padding:10px 12px; border-radius:8px; border:1px solid #e2e8f0;">
                <div style="color:#15803d; line-height:1.4;"><b>ğŸ’¡ ææ¡ˆã®ç†ç”±:</b><br>${merit}</div>
            </div>
            <div style="text-align:center; margin-top:12px;"><button class="apply-btn" onclick="applySwap()">ğŸ”„ ã“ã®ææ¡ˆã‚’è‡ªå‹•ã§é©ç”¨ã™ã‚‹</button></div>
        </div>`;
    }

    let mainFaction = 'tank';
    let s1C = { tank:0, air:0, mis:0 };
    mainSquad.forEach(c => s1C[c.t]++);
    if(s1C.air >= s1C.tank && s1C.air >= s1C.mis) mainFaction = 'air';
    if(s1C.mis >= s1C.tank && s1C.mis >= s1C.air) mainFaction = 'mis';

    let bestFaction = Object.keys(allScores).reduce((a,b)=> allScores[a]>allScores[b]?a:b);
    let fNames = {tank:'æˆ¦è»Š', air:'èˆªç©ºæ©Ÿ', mis:'ãƒ­ã‚±ãƒ©ãƒ³'};
    let topMessage = `ğŸ’¡ <b>${bestFaction === mainFaction ? `ç¾çŠ¶ã®ç·åˆæˆ¦åŠ›ã¯ã€Œ${fNames[bestFaction]}è»¸ã€ãŒæœ€å¼·ã§ã™` : `å…¨ä½“ã§ã¯ã€Œ${fNames[bestFaction]}è»¸ã€ãŒæœ€å¼·ã§ã™ãŒã€ç¬¬1éƒ¨éšŠã‚’åŸºæº–ã«ã€Œ${fNames[mainFaction]}è»¸ã€ã®å¼·åŒ–ã‚’ææ¡ˆã—ã¾ã™`}</b>`;

    let bestSq = 1, maxSqScore = squadScores[1];
    if (squadScores[2] > maxSqScore) { bestSq = 2; maxSqScore = squadScores[2]; }
    if (squadScores[3] > maxSqScore) { bestSq = 3; maxSqScore = squadScores[3]; }
    let squadWarning = bestSq !== 1 && maxSqScore > squadScores[1] + 15 ? `<div style="font-size:0.75rem; color:#b91c1c; background:#fef2f2; padding:8px; border-radius:6px; margin-top:10px; font-weight:bold; border:1px solid #fecaca;">âš ï¸ ç¬¬${bestSq}éƒ¨éšŠã®æˆ¦åŠ›ãŒç¬¬1éƒ¨éšŠã‚’ä¸Šå›ã£ã¦ã„ã¾ã™ã€‚ãƒ¡ã‚¤ãƒ³äº¤ä»£ã‚‚ãŠã™ã™ã‚ã§ã™ï¼</div>` : "";

    let scoreTxt = `<div class="score-breakdown">ç¬¬1éƒ¨éšŠã‚¹ã‚³ã‚¢: ç¾åœ¨ <b>${currentEval.score}</b> â¡ å…¥æ›¿å¾Œ <b><span style="color:#b91c1c">${bestSwap ? bestSwap.eval.score : currentEval.score}</span></b> </div>`;
    resultBox.innerHTML = `${topMessage}${squadWarning}<br>${swapCandidateHtml}${scoreTxt}`;
}

function resetSquads() {
    if(confirm("ç·¨æˆã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ")) {
        for(let s=1; s<=4; s++) {
            for(let p=1; p<=getMaxP(s); p++) {
                document.getElementById(`h-${s}-${p}`).value = 'empty';
                document.getElementById(`w-${s}-${p}`).value = 0;
            }
            updateSquad(s);
        }
    }
}

// --- Gear ---
function initGearHTML() {
    const makeRow = (prefix) => GEAR_TYPES.map(g => `
        <div class="g-row"><span class="g-label">${GEAR_NAMES[g]}</span>
        <div class="g-input-group">
            <div class="stepper stepper-lv"><button onclick="gearStep('${prefix}${g}Lv', -1)">-</button><input id="${prefix}${g}Lv" value="40" readonly><button onclick="gearStep('${prefix}${g}Lv', 1)">+</button></div>
            <div class="stepper stepper-star"><button onclick="gearStep('${prefix}${g}Star', -1)">-</button><input id="${prefix}${g}Star" data-val="0" value="â˜†â˜†â˜†â˜†â˜†" readonly><button onclick="gearStep('${prefix}${g}Star', 1)">+</button></div>
        </div></div>`).join('');
    document.getElementById('current-gear-rows').innerHTML = makeRow('c');
    document.getElementById('target-gear-rows').innerHTML = makeRow('t');
}

function gearStep(id, d) {
    let el = document.getElementById(id);
    let isStar = id.includes('Star');
    let v = isStar ? parseInt(el.getAttribute('data-val')) : parseInt(el.value);
    let max = isStar ? 5 : (id.includes('Weapon') ? 30 : 40); 
    let newVal = Math.min(Math.max(v + d, 0), max);
    
    if(isStar) {
        el.setAttribute('data-val', newVal);
        let s = ""; for(let i=0; i<5; i++) s += i<newVal ? "â˜…":"â˜†";
        el.value = s;
        el.style.color = newVal===5 ? "#ef4444" : newVal>0 ? "#f59e0b" : "#cbd5e1";
    } else { el.value = newVal; }
    calculateGear(); saveData();
}

function calculateGear() {
    ['c', 't'].forEach(p => {
        GEAR_TYPES.forEach(g => {
            let lvEl = document.getElementById(`${p}${g}Lv`), starEl = document.getElementById(`${p}${g}Star`), wrap = starEl.closest('.stepper');
            if (parseInt(lvEl.value) < 40) {
                starEl.setAttribute('data-val', 0); starEl.value = "â˜†â˜†â˜†â˜†â˜†"; starEl.style.color = "#cbd5e1"; wrap.classList.add('disabled');
            } else { wrap.classList.remove('disabled'); }
        });
    });

    const urReq = [0, 5, 15, 30, 50, 50], mrReq = [0, 0, 0, 0, 0, 10];
    let costUr = 0, costMr = 0, listHtml = "";
    
    GEAR_TYPES.forEach(g => {
        let cS = parseInt(document.getElementById(`c${g}Star`).getAttribute('data-val'));
        let tS = parseInt(document.getElementById(`t${g}Star`).getAttribute('data-val'));
        if(tS > cS) {
            let u = urReq[tS] - urReq[cS], m = mrReq[tS] - mrReq[cS];
            costUr += u; costMr += m;
            let txt = [];
            if(u>0) txt.push(`<span style="color:#f59e0b">UR${u}</span>`);
            if(m>0) txt.push(`<span style="color:#b91c1c">MR${m}</span>`);
            listHtml += `<div class="cost-row"><span>${GEAR_NAMES[g]} â˜…${cS}â†’${tS}</span><span>${txt.join('+')}</span></div>`;
        }
    });
    
    document.getElementById('cost-list').innerHTML = listHtml || "<span style='color:#94a3b8;'>è¿½åŠ ã‚³ã‚¹ãƒˆãªã—</span>";
    document.getElementById('ft-ur').innerText = costUr; document.getElementById('ft-mr').innerText = costMr;

    const calcP = (p) => {
        let wp = parseInt(document.getElementById(`${p}Weapon`).value), m = 1.0, myth = [];
        GEAR_TYPES.forEach(g => {
            let lv = parseInt(document.getElementById(`${p}${g}Lv`).value), st = parseInt(document.getElementById(`${p}${g}Star`).getAttribute('data-val'));
            let base = 1 + (lv * 0.005) + (st * 0.05); 
            if(st===5) { base += 0.1; myth.push(GEAR_NAMES[g].replace(/[\u231a-\u26ff]/g, '')); }
            m *= base;
        });
        return { val: (m * (1 + wp * 0.02)).toFixed(2), myth };
    };

    let resC = calcP('c'), resT = calcP('t');
    document.getElementById('growth-rate').innerText = (resC.val > 0) ? (resT.val / resC.val).toFixed(2) : "1.00";
    
    let dBuff = (id, arr) => {
        let el = document.getElementById(id);
        if(arr.length === 0) { el.innerHTML = ""; el.classList.remove('active'); } 
        else { el.innerHTML = "<b>ç™ºå‹•ä¸­:</b> " + arr.join(" / "); el.classList.add('active'); }
    };
    dBuff('detail-curr', resC.myth); dBuff('detail-tgt', resT.myth);
}

// --- Data Save/Load ---
function saveData() {
    let d = {};
    for(let s=1; s<=4; s++) {
        for(let p=1; p<=getMaxP(s); p++) {
            d[`h-${s}-${p}`] = document.getElementById(`h-${s}-${p}`).value;
            d[`w-${s}-${p}`] = document.getElementById(`w-${s}-${p}`).value;
        }
    }
    ['c','t'].forEach(p => {
        d[`${p}Weapon`] = document.getElementById(`${p}Weapon`).value;
        GEAR_TYPES.forEach(g => {
            d[`${p}${g}Lv`] = document.getElementById(`${p}${g}Lv`).value;
            d[`${p}${g}Star`] = document.getElementById(`${p}${g}Star`).getAttribute('data-val');
        });
    });
    // æ—¢å­˜ã®ä¿å­˜ãƒ‡ãƒ¼ã‚¿ã‚’ç¶­æŒã™ã‚‹ãŸã‚ã‚­ãƒ¼ã¯ãã®ã¾ã¾
    localStorage.setItem('lw_sim_final_layout_v9', JSON.stringify(d));
}

function loadAllData() {
    let saved = localStorage.getItem('lw_sim_final_layout_v9');
    if(saved) {
        let d = JSON.parse(saved);
        for(let s=1; s<=4; s++) {
            for(let p=1; p<=getMaxP(s); p++) {
                if(d[`h-${s}-${p}`]) document.getElementById(`h-${s}-${p}`).value = d[`h-${s}-${p}`];
                if(d[`w-${s}-${p}`]) document.getElementById(`w-${s}-${p}`).value = d[`w-${s}-${p}`];
            }
        }
        ['c','t'].forEach(p => {
            if(d[`${p}Weapon`]) document.getElementById(`${p}Weapon`).value = d[`${p}Weapon`];
            GEAR_TYPES.forEach(g => {
                if(d[`${p}${g}Lv`]) document.getElementById(`${p}${g}Lv`).value = d[`${p}${g}Lv`];
                if(d[`${p}${g}Star`]) gearStep(`${p}${g}Star`, parseInt(d[`${p}${g}Star`])); 
            });
        });
    }
    for(let s=1; s<=4; s++) updateSquad(s, true);
    generateAiSuggestion();
}

function resetGear() {
    ['c','t'].forEach(p => {
        document.getElementById(`${p}Weapon`).value = 20;
        GEAR_TYPES.forEach(g => {
            document.getElementById(`${p}${g}Lv`).value = 40;
            gearStep(`${p}${g}Star`, -5); 
        });
    });
    calculateGear(); saveData();
}
</script>
</body>
</html>
